{"componentChunkName":"component---src-templates-post-template-js","path":"/sw_development/devops/aws-ecr-replication-cross-account/","result":{"data":{"site":{"siteMetadata":{"title":"Louis","author":"Louis"}},"markdownRemark":{"id":"e503066c-c35c-53a5-b548-aa0530333258","excerpt":"애플리케이션은 대부분 CI로 컨테이너 이미지를 컨테이너 레지스트리로 업로드 하고 사용하게 된다. 예를 들면 CI(Github Actions, CircleCI 등)에서 이미지를 생성하고 AWS ECR에 이미지를 업로드하면 AWS EKS에서는 ECR에 업로드된 이미지를 사용할 수 있다. 그런데 AWS에서 동일한 컨테이너 이미지를 다수의 계정과 여러 리전에서 사용하고 서비스를 운영해야 한다면 어떻게 하는 것이 좋을까?","html":"<p>애플리케이션은 대부분 CI로 컨테이너 이미지를 컨테이너 레지스트리로 업로드 하고 사용하게 된다. 예를 들면 CI(Github Actions, CircleCI 등)에서 이미지를 생성하고 AWS ECR에 이미지를 업로드하면 AWS EKS에서는 ECR에 업로드된 이미지를 사용할 수 있다.</p>\n<p>그런데 AWS에서 동일한 컨테이너 이미지를 다수의 계정과 여러 리전에서 사용하고 서비스를 운영해야 한다면 어떻게 하는 것이 좋을까?</p>\n<!-- more -->\n<h1>Thinking : Two Strategy</h1>\n<hr>\n<ul>\n<li>첫 번째 전략은 CI 또는 배치를 사용해 각 계정 및 리전의 ECR로 각각 업로드하는 것이다.\n<ul>\n<li>각 ECR에는 필요한 컨테이너 이미지만 존재할 수 있다.</li>\n<li>CI 코드가 길어지고 추가 및 변경되는 환경이 생기면 CI 코드 수정은 불가피하다.</li>\n<li>많은 애플리케이션을 운영하는 경우 모든 애플리케이션의 CI 코드 수정이 필요하고, 애플리케이션의 이미지 업로드를 한 곳에서 담당하고 있다면 대기열이 모두 차고 지연이 발생할 수 있다.</li>\n</ul>\n</li>\n<li>두 번째 전략은 하나의 ECR에 이미지를 업로드하고 필요한 계정과 리전으로 복제하는 것이다.\n<ul>\n<li>원본이 업로드되는 ECR은 모든 이미지가 존재하기 때문에 불필요한 용량을 사용하게 된다.</li>\n<li>CI 코드가 비교적 간결하지만 인프라 설정이 필요하다.</li>\n<li>CI의 잡은 완료되었지만 복제에 따른 시간 지연이 있을 수 있다. 경험 상 지연 시간은 수 초에서 1분 미만인 것 같다.</li>\n</ul>\n</li>\n</ul>\n<h1>Choice : Second Strategy</h1>\n<hr>\n<p>본 글은 두 번째 전략 방식을 선택하고 계정간 ECR 이미지 복제 설정을 설명한다.</p>\n<p>계정간 ECR Repositories 복제는 두 계정의 ECR(Source &#x26; Destination)에 각각 설정이 필요하다. Source ECR에서는 replication 설정을 해줘야 하고, Destination ECR에서는 permission 설정을 해줘야 한다.</p>\n<p>복제 설정 전에 업로드된 이미지들은 복제(동기화)되지 않는다. 복제 설정 후 업로드된 이미지부터 동기화되니 참고하자.</p>\n<h2>1. Source Image Registry</h2>\n<ul>\n<li>이 설정은 원본 ECR의 Repositories 및 이미지를 다른 계정의 리전으로 복제하기 위함이다.</li>\n<li>원본 컨테이너 이미지가 존재하는 AWS 계정의 ECR 메뉴로 이동한다.</li>\n<li>Private Registry > Replication > Add rule 메뉴를 클릭한다.</li>\n<li>Destination Types은 Cross-account replication을 선택한다.</li>\n<li>Configure replication rule에서는 복제될 ECR이 존재하는 계정과 리전 정보를 입력한다.</li>\n<li>Filters는 선택사항이다. 입력하지 않으면 모든 이미지를 복제하고 설정하면 필터 조건에 맞는 이미지만 복제된다. 예를 들어, 레포지토리 이름이 production-webserver, production-database, qa-webserver, qa-database이고 production prefix를 가진 레포지토리만 복사하길 원하는 경우 production을 필터 조건으로 입력하면 된다.</li>\n<li>Submit rule까지 클릭하면 복제 설정 생성 완료이다.</li>\n</ul>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 970px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/339a72a4ef55710943f08fb290940a2d/1250c/ecr-replication-01.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 89.71193415637859%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAASABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAIDBf/EABYBAQEBAAAAAAAAAAAAAAAAAAABAv/aAAwDAQACEAMQAAAB7dSLSKkMxm//xAAZEAADAAMAAAAAAAAAAAAAAAAAEBEBITH/2gAIAQEAAQUCKV7ee//EABQRAQAAAAAAAAAAAAAAAAAAACD/2gAIAQMBAT8BH//EABQRAQAAAAAAAAAAAAAAAAAAACD/2gAIAQIBAT8BH//EABQQAQAAAAAAAAAAAAAAAAAAADD/2gAIAQEABj8CH//EABwQAAICAgMAAAAAAAAAAAAAAAABESEQQTFhcf/aAAgBAQABPyGqoUKg8CnoudZPkZ7M/9oADAMBAAIAAwAAABAwDwP/xAAXEQADAQAAAAAAAAAAAAAAAAAAARAx/9oACAEDAQE/EKsP/8QAFhEAAwAAAAAAAAAAAAAAAAAAAAEQ/9oACAECAQE/EKz/xAAcEAADAQACAwAAAAAAAAAAAAAAASERUXFhgbH/2gAIAQEAAT8QTZVEQaHYNpeA9sqo1FS9GLhEROje+h//2Q=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/339a72a4ef55710943f08fb290940a2d/fc615/ecr-replication-01.avif 243w,\n/static/339a72a4ef55710943f08fb290940a2d/b3175/ecr-replication-01.avif 485w,\n/static/339a72a4ef55710943f08fb290940a2d/006d3/ecr-replication-01.avif 970w,\n/static/339a72a4ef55710943f08fb290940a2d/fcbe8/ecr-replication-01.avif 1178w\"\n              sizes=\"(max-width: 970px) 100vw, 970px\"\n              type=\"image/avif\"\n            /><source\n              srcset=\"/static/339a72a4ef55710943f08fb290940a2d/0e3e2/ecr-replication-01.webp 243w,\n/static/339a72a4ef55710943f08fb290940a2d/749af/ecr-replication-01.webp 485w,\n/static/339a72a4ef55710943f08fb290940a2d/dbca2/ecr-replication-01.webp 970w,\n/static/339a72a4ef55710943f08fb290940a2d/3126b/ecr-replication-01.webp 1178w\"\n              sizes=\"(max-width: 970px) 100vw, 970px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/339a72a4ef55710943f08fb290940a2d/3f316/ecr-replication-01.jpg 243w,\n/static/339a72a4ef55710943f08fb290940a2d/0d3a1/ecr-replication-01.jpg 485w,\n/static/339a72a4ef55710943f08fb290940a2d/ec7ce/ecr-replication-01.jpg 970w,\n/static/339a72a4ef55710943f08fb290940a2d/1250c/ecr-replication-01.jpg 1178w\"\n            sizes=\"(max-width: 970px) 100vw, 970px\"\n            type=\"image/jpeg\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/339a72a4ef55710943f08fb290940a2d/ec7ce/ecr-replication-01.jpg\"\n            alt=\"원본 컨테이너 이미지가 위치한 계정의 ECR의 replication 설정\"\n            title=\"원본 컨테이너 이미지가 위치한 계정의 ECR의 replication 설정\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<h2>2. Destination Image Registry</h2>\n<ul>\n<li>이 설정은 원본 ECR이 위치한 계정이 본 계정으로 이미지를 복사하는 행동을 허용하기 위함이다.</li>\n<li>컨테이너 이미지가 복제되야 할 AWS 계정의 ECR 메뉴로 이동한다.</li>\n<li>Private Registry > Permissions > Generate statement 메뉴를 클릭한다.</li>\n<li>policy type은 Cross account replication policy를 선택한다.</li>\n<li>Statement id는 정책 식별자이다. AWS IAM의 Sid로 보면된다.</li>\n<li>Accounts에는 퍼미션을 승인할 계정을 입력한다. 원본 ECR의 AWS 계정을 입력하면 된다.</li>\n</ul>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 697px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/57ba7333a944820068ef69a0b6651f42/721dc/ecr-replication-02.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 129.21810699588477%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAaABQDASIAAhEBAxEB/8QAGAABAQEBAQAAAAAAAAAAAAAAAAECBAX/xAAVAQEBAAAAAAAAAAAAAAAAAAAAAf/aAAwDAQACEAMQAAAB9yKQF1iGnMl//8QAGBAAAwEBAAAAAAAAAAAAAAAAAAEQESH/2gAIAQEAAQUCzmDFsddR/8QAFhEAAwAAAAAAAAAAAAAAAAAAABAR/9oACAEDAQE/AXD/xAAWEQADAAAAAAAAAAAAAAAAAAAAEBH/2gAIAQIBAT8BdP/EABQQAQAAAAAAAAAAAAAAAAAAADD/2gAIAQEABj8CT//EABoQAQACAwEAAAAAAAAAAAAAAAEAERAhMUH/2gAIAQEAAT8hBaO2lyKYIe3jrC6ja7P/2gAMAwEAAgADAAAAEJMEDP/EABcRAQADAAAAAAAAAAAAAAAAAAEAEBH/2gAIAQMBAT8Qtwz/xAAXEQEAAwAAAAAAAAAAAAAAAAABABAR/9oACAECAQE/ELNE/8QAHhABAAICAgMBAAAAAAAAAAAAAQARITFBUWFxgZH/2gAIAQEAAT8QIFALx1KRWPjACU8QURcTzMQduobwc4zUNbf2avUt7Y1ssQ7Tnuf/2Q=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/57ba7333a944820068ef69a0b6651f42/fc615/ecr-replication-02.avif 243w,\n/static/57ba7333a944820068ef69a0b6651f42/b3175/ecr-replication-02.avif 485w,\n/static/57ba7333a944820068ef69a0b6651f42/eb50a/ecr-replication-02.avif 697w\"\n              sizes=\"(max-width: 697px) 100vw, 697px\"\n              type=\"image/avif\"\n            /><source\n              srcset=\"/static/57ba7333a944820068ef69a0b6651f42/0e3e2/ecr-replication-02.webp 243w,\n/static/57ba7333a944820068ef69a0b6651f42/749af/ecr-replication-02.webp 485w,\n/static/57ba7333a944820068ef69a0b6651f42/458b7/ecr-replication-02.webp 697w\"\n              sizes=\"(max-width: 697px) 100vw, 697px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/57ba7333a944820068ef69a0b6651f42/3f316/ecr-replication-02.jpg 243w,\n/static/57ba7333a944820068ef69a0b6651f42/0d3a1/ecr-replication-02.jpg 485w,\n/static/57ba7333a944820068ef69a0b6651f42/721dc/ecr-replication-02.jpg 697w\"\n            sizes=\"(max-width: 697px) 100vw, 697px\"\n            type=\"image/jpeg\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/57ba7333a944820068ef69a0b6651f42/721dc/ecr-replication-02.jpg\"\n            alt=\"원본이 복제될 계정의 ECR의 permission 설정\"\n            title=\"원본이 복제될 계정의 ECR의 permission 설정\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<h1>참고</h1>\n<hr>\n<ul>\n<li><a href=\"https://docs.aws.amazon.com/AmazonECR/latest/userguide/replication.html\">https://docs.aws.amazon.com/AmazonECR/latest/userguide/replication.html</a></li>\n<li><a href=\"https://docs.aws.amazon.com/AmazonECR/latest/userguide/registry-settings-configure.html\">https://docs.aws.amazon.com/AmazonECR/latest/userguide/registry-settings-configure.html</a></li>\n<li><a href=\"https://docs.aws.amazon.com/AmazonECR/latest/userguide/registry-permissions.html\">https://docs.aws.amazon.com/AmazonECR/latest/userguide/registry-permissions.html</a></li>\n</ul>","fields":{"slug":"/sw_development/devops/aws-ecr-replication-cross-account/"},"frontmatter":{"title":"AWS. 다른 계정의 ECR 이미지 복제하기","searchTexts":["AWS ECR Image Replication for Cross-account"],"category":"sw development","subCategory":"devops","tags":["AWS","ECR"],"created":"Nov 16, 2022","updated":"Nov 16, 2022"},"tableOfContents":"<ul>\n<li>\n<p><a href=\"#thinking--two-strategy\">Thinking : Two Strategy</a></p>\n</li>\n<li>\n<p><a href=\"#choice--second-strategy\">Choice : Second Strategy</a></p>\n<ul>\n<li><a href=\"#1-source-image-registry\">1. Source Image Registry</a></li>\n<li><a href=\"#2-destination-image-registry\">2. Destination Image Registry</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%EC%B0%B8%EA%B3%A0\">참고</a></p>\n</li>\n</ul>"}},"pageContext":{"slug":"/sw_development/devops/aws-ecr-replication-cross-account/","prev":{"fields":{"slug":"/life/economy/tesla-musk-elon-2022/"},"frontmatter":{"title":"2022년 머스크의 테슬라 주식 매도 정리","tags":["stock"],"category":"life","subCategory":"economy"}},"next":{"fields":{"slug":"/sw_development/devops/aws-cdk-eks-v23-troubleshooting/"},"frontmatter":{"title":"AWS. EKS CDK Troubleshooting - KubectlV23Layer","tags":["AWS","Kubernetes","K8S","EKS","CDK"],"category":"sw development","subCategory":"devops"}}}},"staticQueryHashes":["2152785458","3427181268"]}