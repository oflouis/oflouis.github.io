{"componentChunkName":"component---src-templates-post-template-js","path":"/sw_development/devops/aws-eks-application-logging-05/","result":{"data":{"site":{"siteMetadata":{"title":"Louis","author":"Louis"}},"markdownRemark":{"id":"ebc83a90-6f09-5143-a8d8-6b3929779fe6","excerpt":"AWS EKS의 애플리케이션 로그를 AWS OpenSearch로 수집하고 관리하기 위한 내용을 정리한다. 로그 전송은 Fluent Bit을 사용했다. 내용은 간단하지만 한 개의 포스팅에 포함하려니 내용이 길어지고 가독성을 해쳐서 몇 개의 파트로 나눴다. 본 포스팅은 Fluent Bit 멀티라인 파싱 설정 내용을 다룬다.","html":"<p>AWS EKS의 애플리케이션 로그를 AWS OpenSearch로 수집하고 관리하기 위한 내용을 정리한다. 로그 전송은 Fluent Bit을 사용했다.</p>\n<p>내용은 간단하지만 한 개의 포스팅에 포함하려니 내용이 길어지고 가독성을 해쳐서 몇 개의 파트로 나눴다.</p>\n<p>본 포스팅은 Fluent Bit 멀티라인 파싱 설정 내용을 다룬다.</p>\n<!-- more -->\n<h1>파트 목차</h1>\n<hr>\n<ul>\n<li><a href=\"https://oflouis.dev/sw_development/devops/aws-eks-application-logging-01/\">로그 수집 구성 개요</a></li>\n<li><a href=\"https://oflouis.dev/sw_development/devops/aws-eks-application-logging-02/\">AWS IRSA, K8S RBAC 설정</a></li>\n<li><a href=\"https://oflouis.dev/sw_development/devops/aws-eks-application-logging-03/\">DaemonSet 설정</a></li>\n<li><a href=\"https://oflouis.dev/sw_development/devops/aws-eks-application-logging-04/\">로그 로테이트 설정</a></li>\n<li><strong>로그 멀티라인 파싱 설정 : 현재 포스트</strong></li>\n</ul>\n<h1>로그 멀티라인 파싱 설정</h1>\n<hr>\n<p>자바 Stack Trace는 멀티라인으로 로그가 출력 된다. 이 경우 오류는 각 개별 라인으로 적재되고 로그를 분석하는데 불편함이 생긴다.\n자바의 Stack Trace 멀티라인 로그를 묶을 수 있도록 설정해보자. 이번에도 Fluent Bit 설정 수정이 필요하다.</p>\n<h2>K8S ConfigMap 수정</h2>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> ConfigMap\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">k8s-app</span><span class=\"token punctuation\">:</span> fluent<span class=\"token punctuation\">-</span>bit\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> fluent<span class=\"token punctuation\">-</span>bit<span class=\"token punctuation\">-</span>config\n  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> logging\n<span class=\"token key atrule\">data</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">fluent-bit.conf</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\"></span>\n<span class=\"token scalar string\">    [SERVICE]</span>\n<span class=\"token scalar string\">        Flush         1</span>\n<span class=\"token scalar string\">        Log_Level     info</span>\n<span class=\"token scalar string\">        Daemon        off</span>\n<span class=\"token scalar string\">        Parsers_File  parsers.conf</span>\n<span class=\"token scalar string\">        HTTP_Server   On</span>\n<span class=\"token scalar string\">        HTTP_Listen   0.0.0.0</span>\n<span class=\"token scalar string\">        HTTP_Port     2020</span>\n\n    @INCLUDE input<span class=\"token punctuation\">-</span>kubernetes.conf\n    @INCLUDE filter<span class=\"token punctuation\">-</span>kubernetes.conf\n<span class=\"gatsby-highlight-code-line\">    @INCLUDE filter<span class=\"token punctuation\">-</span>multiline.conf</span>    @INCLUDE output<span class=\"token punctuation\">-</span>opensearch.conf\n  \n  <span class=\"token key atrule\">input-kubernetes.conf</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\"></span>\n<span class=\"token scalar string\">    [INPUT]</span>\n<span class=\"token scalar string\">        Name              tail</span>\n<span class=\"token scalar string\">        Tag               kube.*</span>\n<span class=\"token scalar string\">        Path              /var/log/containers/*.log</span>\n<span class=\"gatsby-highlight-code-line\"><span class=\"token scalar string\">        Multiline.Parser  docker</span></span><span class=\"token scalar string\">        DB                /var/log/flb_kube.db</span>\n<span class=\"token scalar string\">        Mem_Buf_Limit     5MB</span>\n<span class=\"token scalar string\">        Skip_Long_Lines   On</span>\n<span class=\"token scalar string\">        Refresh_Interval  10</span>\n<span class=\"gatsby-highlight-code-line\"><span class=\"token scalar string\">        Read_From_Head    true</span></span>  \n  <span class=\"token key atrule\">filter-kubernetes.conf</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\"></span>\n<span class=\"token scalar string\">    [FILTER]</span>\n<span class=\"token scalar string\">        Name                kubernetes</span>\n<span class=\"token scalar string\">        Match               kube.*</span>\n<span class=\"token scalar string\">        Kube_URL            https://kubernetes.default.svc:443</span>\n<span class=\"token scalar string\">        Kube_CA_File        /var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span>\n<span class=\"token scalar string\">        Kube_Token_File     /var/run/secrets/kubernetes.io/serviceaccount/token</span>\n<span class=\"token scalar string\">        Kube_Tag_Prefix     kube.var.log.containers.</span>\n<span class=\"token scalar string\">        Merge_Log           On</span>\n<span class=\"token scalar string\">        Merge_Log_Key       log_processed</span>\n<span class=\"token scalar string\">        K8S-Logging.Parser  On</span>\n<span class=\"token scalar string\">        K8S-Logging.Exclude On</span>\n<span class=\"token scalar string\">        </span>\n<span class=\"gatsby-highlight-code-line\">  <span class=\"token key atrule\">filter-multiline.conf</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\"></span></span><span class=\"gatsby-highlight-code-line\"><span class=\"token scalar string\">    [FILTER]</span></span><span class=\"gatsby-highlight-code-line\"><span class=\"token scalar string\">        Name                  multiline</span></span><span class=\"gatsby-highlight-code-line\"><span class=\"token scalar string\">        Match                 *</span></span><span class=\"gatsby-highlight-code-line\"><span class=\"token scalar string\">        Multiline.Key_Content log</span></span><span class=\"gatsby-highlight-code-line\"><span class=\"token scalar string\">        Multiline.Parser      multiline-regex-springboot</span></span>  \n  <span class=\"token key atrule\">output-opensearch.conf</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\"></span>\n<span class=\"token scalar string\">    [OUTPUT]</span>\n<span class=\"token scalar string\">        Name                 es</span>\n<span class=\"token scalar string\">        Match                *</span>\n<span class=\"token scalar string\">        Host                 ${OPENSEARCH_ENDPOINT}</span>\n<span class=\"token scalar string\">        Port                 443</span>\n<span class=\"token scalar string\">        TLS                  On</span>\n<span class=\"token scalar string\">        AWS_Auth             On</span>\n<span class=\"token scalar string\">        AWS_Region           ${AWS_REGION}</span>\n<span class=\"token scalar string\">        Replace_Dots         On</span>\n<span class=\"token scalar string\">        Logstash_Format      On</span>\n<span class=\"token scalar string\">        Logstash_DateFormat  %Y-%m-%d</span>\n<span class=\"token scalar string\">        Logstash_Prefix      ${INDEX_NAME}</span>\n<span class=\"token scalar string\">        </span>\n  <span class=\"token key atrule\">parsers.conf</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\"></span>\n<span class=\"token scalar string\">    [PARSER]</span>\n<span class=\"token scalar string\">        Name        docker</span>\n<span class=\"token scalar string\">        Format      json</span>\n<span class=\"token scalar string\">        Time_Key    time</span>\n<span class=\"token scalar string\">        Time_Format %Y-%m-%dT%H:%M:%S.%L</span>\n<span class=\"token scalar string\">        Time_Keep   On</span>\n\n<span class=\"gatsby-highlight-code-line\">    <span class=\"token punctuation\">[</span>MULTILINE_PARSER<span class=\"token punctuation\">]</span></span><span class=\"gatsby-highlight-code-line\">        <span class=\"token comment\"># https://docs.fluentbit.io/manual/administration/configuring-fluent-bit/multiline-parsing</span></span><span class=\"gatsby-highlight-code-line\">        Name          multiline<span class=\"token punctuation\">-</span>regex<span class=\"token punctuation\">-</span>springboot</span><span class=\"gatsby-highlight-code-line\">        Type          regex</span><span class=\"gatsby-highlight-code-line\">        Flush_Timeout 1000</span><span class=\"gatsby-highlight-code-line\">        <span class=\"token comment\"># rules |   state name  | regex pattern                                 | next state</span></span><span class=\"gatsby-highlight-code-line\">        <span class=\"token comment\"># ------|---------------|-----------------------------------------------|-------------</span></span><span class=\"gatsby-highlight-code-line\">        Rule      \"start_state\"   \"/(\\d+\\<span class=\"token punctuation\">-</span>\\d+\\<span class=\"token punctuation\">-</span>\\d+ \\d+\\<span class=\"token punctuation\">:</span>\\d+\\<span class=\"token punctuation\">:</span>\\d+\\.\\d+\\s)(.<span class=\"token important\">*)/\"</span>    \"cont\"</span><span class=\"gatsby-highlight-code-line\">        Rule      \"cont\"          \"/^(<span class=\"token punctuation\">?</span><span class=\"token tag\">!</span>\\d+\\<span class=\"token punctuation\">-</span>\\d+\\<span class=\"token punctuation\">-</span>\\d+ \\d+\\<span class=\"token punctuation\">:</span>\\d+\\<span class=\"token punctuation\">:</span>\\d+\\.\\d+\\s).<span class=\"token important\">*/\"</span>   \"cont\"</span></code></pre></div>\n<h1>참고</h1>\n<hr>\n<ul>\n<li><a href=\"https://docs.fluentbit.io/manual/administration/configuring-fluent-bit/multiline-parsing\">https://docs.fluentbit.io/manual/administration/configuring-fluent-bit/multiline-parsing</a></li>\n</ul>","fields":{"slug":"/sw_development/devops/aws-eks-application-logging-05/"},"frontmatter":{"title":"AWS. EKS 애플리케이션 로그 수집하기 (5)","searchTexts":["AWS EKS 로그 수집","AWS OpenSearch에 Kubernetes 로그 수집","EKS와 Fluent Bit, OpenSearch 로그 수집","Fluent Bit 스프링부트 멀티라인 파싱 설정","Fluent Bit SpringBoot Multiline Parsing"],"category":"sw development","subCategory":"devops","tags":["AWS","Kubernetes","K8S","OpenSearch","Logging","EKS","EFK"],"created":"Sep 11, 2022","updated":"Oct 15, 2022"},"tableOfContents":"<ul>\n<li>\n<p><a href=\"#%ED%8C%8C%ED%8A%B8-%EB%AA%A9%EC%B0%A8\">파트 목차</a></p>\n</li>\n<li>\n<p><a href=\"#%EB%A1%9C%EA%B7%B8-%EB%A9%80%ED%8B%B0%EB%9D%BC%EC%9D%B8-%ED%8C%8C%EC%8B%B1-%EC%84%A4%EC%A0%95\">로그 멀티라인 파싱 설정</a></p>\n<ul>\n<li><a href=\"#k8s-configmap-%EC%88%98%EC%A0%95\">K8S ConfigMap 수정</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%EC%B0%B8%EA%B3%A0\">참고</a></p>\n</li>\n</ul>"}},"pageContext":{"slug":"/sw_development/devops/aws-eks-application-logging-05/","prev":{"fields":{"slug":"/sw_development/devops/aws-eks-application-logging-04/"},"frontmatter":{"title":"AWS. EKS 애플리케이션 로그 수집하기 (4)","tags":["AWS","Kubernetes","K8S","OpenSearch","Logging","EKS","EFK"],"category":"sw development","subCategory":"devops"}},"next":{"fields":{"slug":"/sw_development/devops/aws-eks-application-logging-01/"},"frontmatter":{"title":"AWS. EKS 애플리케이션 로그 수집하기 (1)","tags":["AWS","Kubernetes","K8S","OpenSearch","Logging","EKS","EFK"],"category":"sw development","subCategory":"devops"}}}},"staticQueryHashes":["2152785458","3427181268"]}