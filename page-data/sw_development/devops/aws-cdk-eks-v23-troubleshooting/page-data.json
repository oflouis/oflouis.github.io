{"componentChunkName":"component---src-templates-post-template-js","path":"/sw_development/devops/aws-cdk-eks-v23-troubleshooting/","result":{"data":{"site":{"siteMetadata":{"title":"Louis","author":"Louis"}},"markdownRemark":{"id":"a191c83e-d4dd-5b46-86d5-a23404099e14","excerpt":"AWS CDK를 사용해서 EKS를 관리하고 있는데, 노드 그룹 추가하면서 EKS 업데이트 오류가 발생했다. 현재 사용 중인 EKS 버전은 v23이다. 비용 최적화로 노드(EC2 인스턴스)를 많이 쓰기 어렵고, 네트워크 IP 관리로 IP도 작은 대역을 받아야 한다. 적은 리소스로 시작하고 증설하는 것을 고려해야 하니 IP 고갈 상황을 가정하고 서브넷과 노드를 추가하는 것을 테스트하다 발견하게 되었다.","html":"<p>AWS CDK를 사용해서 EKS를 관리하고 있는데, 노드 그룹 추가하면서 EKS 업데이트 오류가 발생했다. 현재 사용 중인 EKS 버전은 v23이다.</p>\n<p>비용 최적화로 노드(EC2 인스턴스)를 많이 쓰기 어렵고, 네트워크 IP 관리로 IP도 작은 대역을 받아야 한다. 적은 리소스로 시작하고 증설하는 것을 고려해야 하니 IP 고갈 상황을 가정하고 서브넷과 노드를 추가하는 것을 테스트하다 발견하게 되었다.</p>\n<!-- more -->\n<h1>Incompatible Kubectl Version</h1>\n<hr>\n<p>처음 맞이한 오류는 kubectl version 오류였다.</p>\n<p>이 오류로 v22부터 KubectlLayer를 추가해줘야 한다는 사실을 알게 되었다. 해결하기 위한 방법은 KubectlLayer만 추가하면 되었기 때문에 의외로 간단했다.</p>\n<h2>Error Message</h2>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">Received response status <span class=\"token punctuation\">[</span>FAILED<span class=\"token punctuation\">]</span> from custom resource. \nMessage returned: \nError: b<span class=\"token string\">'configmap/aws-auth configured\\nerror: error retrieving RESTMappings to prune: invalid resource extensions/v1beta1, Kind=Ingress, Namespaced=true: no matches for kind \"Ingress\" in version \"extensions/v1beta1\"\\n'</span>\nLogs: /aws/lambda/eks-cluster-name-awscdkawse-Handler886CB40B-g4KR4U875rYD at invokeUserFunction <span class=\"token punctuation\">(</span>/var/task/framework.js:2:6<span class=\"token punctuation\">)</span> at processTicksAndRejections <span class=\"token punctuation\">(</span>internal/process/task_queues.js:95:5<span class=\"token punctuation\">)</span> at async onEvent <span class=\"token punctuation\">(</span>/var/task/framework.js:1:365<span class=\"token punctuation\">)</span> at async Runtime.handler <span class=\"token punctuation\">(</span>/var/task/cfn-response.js:1:1474<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span>RequestId: 6fae4ba7-ef6d-4613-a129-7c2bc1566fe7<span class=\"token punctuation\">)</span></code></pre></div>\n<h2>Solution</h2>\n<ul>\n<li>lambda-layer-kubectl-v23 설치</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token function\">npm</span> <span class=\"token function\">install</span> @aws-cdk/lambda-layer-kubectl-v23</code></pre></div>\n<ul>\n<li>eks cluster 생성 시 kubectlLayer 지정</li>\n</ul>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"gatsby-highlight-code-line\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> KubectlV23Layer <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'@aws-cdk/lambda-layer-kubectl-v23'</span><span class=\"token punctuation\">;</span></span>\n<span class=\"token keyword\">const</span> cluster <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">eks</span><span class=\"token punctuation\">.</span><span class=\"token function\">Cluster</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'EksCluster'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// 생략..</span>\n<span class=\"gatsby-highlight-code-line\">  kubectlLayer<span class=\"token operator\">:</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">KubectlV23Layer</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'KubectlLayer'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></span>  <span class=\"token comment\">// 생략..</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h1>FileNotFoundError</h1>\n<hr>\n<p>그런데 두 번째 오류가 발생했다. aws 디렉토리를 못찾는다는 오류였다.</p>\n<h2>Error Message</h2>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token punctuation\">[</span>ERROR<span class=\"token punctuation\">]</span> FileNotFoundError: <span class=\"token punctuation\">[</span>Errno <span class=\"token number\">2</span><span class=\"token punctuation\">]</span> No such <span class=\"token function\">file</span> or directory: <span class=\"token string\">'aws'</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">'aws'</span>\nTraceback <span class=\"token punctuation\">(</span>most recent call last<span class=\"token punctuation\">)</span>:\n  File <span class=\"token string\">\"/var/task/index.py\"</span>, line <span class=\"token number\">14</span>, <span class=\"token keyword\">in</span> handler\n    <span class=\"token builtin class-name\">return</span> apply_handler<span class=\"token punctuation\">(</span>event, context<span class=\"token punctuation\">)</span>\n  File <span class=\"token string\">\"/var/task/apply/__init__.py\"</span>, line <span class=\"token number\">37</span>, <span class=\"token keyword\">in</span> apply_handler\n    subprocess.check_call<span class=\"token punctuation\">(</span>cmd<span class=\"token punctuation\">)</span>\n  File <span class=\"token string\">\"/var/lang/lib/python3.7/subprocess.py\"</span>, line <span class=\"token number\">358</span>, <span class=\"token keyword\">in</span> check_call\n    retcode <span class=\"token operator\">=</span> call<span class=\"token punctuation\">(</span>*popenargs, **kwargs<span class=\"token punctuation\">)</span>\n  File <span class=\"token string\">\"/var/lang/lib/python3.7/subprocess.py\"</span>, line <span class=\"token number\">339</span>, <span class=\"token keyword\">in</span> call\n    with Popen<span class=\"token punctuation\">(</span>*popenargs, **kwargs<span class=\"token punctuation\">)</span> as p:\n  File <span class=\"token string\">\"/var/lang/lib/python3.7/subprocess.py\"</span>, line <span class=\"token number\">800</span>, <span class=\"token keyword\">in</span> __init__\n    restore_signals, start_new_session<span class=\"token punctuation\">)</span>\n  File <span class=\"token string\">\"/var/lang/lib/python3.7/subprocess.py\"</span>, line <span class=\"token number\">1551</span>, <span class=\"token keyword\">in</span> _execute_child\n    raise child_exception_type<span class=\"token punctuation\">(</span>errno_num, err_msg, err_filename<span class=\"token punctuation\">)</span></code></pre></div>\n<h2>Solution</h2>\n<p>KubectlLayer 추가로 발생하는 오류였는데, 오류 내용과 리서치로는 해결 방법을 찾기가 어려웠다.</p>\n<p>다른 곳에 코드 수정이 필요할 수도 있지만, 일단 cdk 버전을 업데이트하기로 했다. 그리고 오류가 해결되었다.</p>\n<ul>\n<li>cdk 및 packages 버전 업데이트</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">npx ncu -u\n<span class=\"token function\">rm</span> package-lock.json\n<span class=\"token function\">rm</span> -rf ./node_modules\n<span class=\"token function\">npm</span> <span class=\"token function\">install</span></code></pre></div>\n<h1>결론</h1>\n<hr>\n<ul>\n<li>AWS CDK를 사용해 v22 이상의 EKS를 생성 및 관리하고 있다면, KubectlLayer를 추가해야 한다.</li>\n<li>KubectlLayer는 CDK 버전이 맞지 않으면 오류가 발생한다. CDK v2.50.0에서는 정상 동작한다.</li>\n</ul>\n<h2>현재 내 버전 정보</h2>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">$ node -v                                                                                                                                                                                          ✔ │ 09:08:07 PM \nv16.16.0\n\n$ cdk version                                                                                                                                                                                      ✔ │ <span class=\"token number\">11</span>:23:02 PM \n<span class=\"token number\">2.50</span>.0 <span class=\"token punctuation\">(</span>build 4c11af6<span class=\"token punctuation\">)</span></code></pre></div>\n<h1>참고</h1>\n<hr>\n<ul>\n<li><a href=\"https://github.com/aws/aws-cdk/issues/19843\">https://github.com/aws/aws-cdk/issues/19843</a></li>\n<li><a href=\"https://docs.aws.amazon.com/cdk/api/v2/docs/aws-cdk-lib.aws_eks.KubernetesVersion.html\">https://docs.aws.amazon.com/cdk/api/v2/docs/aws-cdk-lib.aws_eks.KubernetesVersion.html</a></li>\n</ul>","fields":{"slug":"/sw_development/devops/aws-cdk-eks-v23-troubleshooting/"},"frontmatter":{"title":"AWS. EKS CDK Troubleshooting - KubectlV23Layer","searchTexts":["no matches for kind \"Ingress\" in version \"extensions/v1beta1\"","No such file or directory: \"aws\"","AWS CDK EKS v22, v23"],"category":"sw development","subCategory":"devops","tags":["AWS","Kubernetes","K8S","EKS","CDK"],"created":"Nov 08, 2022","updated":"Nov 08, 2022"},"tableOfContents":"<ul>\n<li>\n<p><a href=\"#incompatible-kubectl-version\">Incompatible Kubectl Version</a></p>\n<ul>\n<li><a href=\"#error-message\">Error Message</a></li>\n<li><a href=\"#solution\">Solution</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#filenotfounderror\">FileNotFoundError</a></p>\n<ul>\n<li><a href=\"#error-message-1\">Error Message</a></li>\n<li><a href=\"#solution-1\">Solution</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%EA%B2%B0%EB%A1%A0\">결론</a></p>\n<ul>\n<li><a href=\"#%ED%98%84%EC%9E%AC-%EB%82%B4-%EB%B2%84%EC%A0%84-%EC%A0%95%EB%B3%B4\">현재 내 버전 정보</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%EC%B0%B8%EA%B3%A0\">참고</a></p>\n</li>\n</ul>"}},"pageContext":{"slug":"/sw_development/devops/aws-cdk-eks-v23-troubleshooting/","prev":{"fields":{"slug":"/sw_development/devops/aws-ecr-replication-cross-account/"},"frontmatter":{"title":"AWS. 다른 계정의 ECR 이미지 복제하기","tags":["AWS","ECR"],"category":"sw development","subCategory":"devops"}},"next":{"fields":{"slug":"/sw_development/etc/openssl-cve-20221101/"},"frontmatter":{"title":"OpenSSL 보안 취약점 업데이트 권고 발표 ( CVE-2022-3602, CVE-2022-3786 )","tags":["Security"],"category":"sw development","subCategory":"etc"}}}},"staticQueryHashes":["2152785458","3427181268"]}