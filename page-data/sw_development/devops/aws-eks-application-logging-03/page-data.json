{"componentChunkName":"component---src-templates-post-template-js","path":"/sw_development/devops/aws-eks-application-logging-03/","result":{"data":{"site":{"siteMetadata":{"title":"Louis","author":"Louis"}},"markdownRemark":{"id":"31857d82-1ee6-571e-8382-87f1e1174bbf","excerpt":"AWS EKS의 애플리케이션 로그를 AWS OpenSearch로 수집하고 관리하기 위한 내용을 정리한다. 로그 전송은 Fluent Bit을 사용했다. 내용은 간단하지만 한 개의 포스팅에 포함하려니 내용이 길어지고 가독성을 해쳐서 몇 개의 파트로 나눴다. 본 포스팅은 Fluent Bit DaemonSet을 설정하는 내용을 다룬다.","html":"<p>AWS EKS의 애플리케이션 로그를 AWS OpenSearch로 수집하고 관리하기 위한 내용을 정리한다. 로그 전송은 Fluent Bit을 사용했다.</p>\n<p>내용은 간단하지만 한 개의 포스팅에 포함하려니 내용이 길어지고 가독성을 해쳐서 몇 개의 파트로 나눴다.</p>\n<p>본 포스팅은 Fluent Bit DaemonSet을 설정하는 내용을 다룬다.</p>\n<!-- more -->\n<h1>파트 목차</h1>\n<hr>\n<ul>\n<li><a href=\"https://oflouis.dev/sw_development/devops/aws-eks-application-logging-01/\">로그 수집 구성 개요</a></li>\n<li><a href=\"https://oflouis.dev/sw_development/devops/aws-eks-application-logging-02/\">AWS IRSA, K8S RBAC 설정</a></li>\n<li><strong>DaemonSet 설정 : 현재 포스트</strong></li>\n<li><a href=\"https://oflouis.dev/sw_development/devops/aws-eks-application-logging-04/\">로그 로테이트 설정</a></li>\n<li><a href=\"https://oflouis.dev/sw_development/devops/aws-eks-application-logging-05/\">로그 멀티라인 파싱 설정</a></li>\n</ul>\n<h1>Fluent Bit DaemonSet 설정</h1>\n<hr>\n<h2>OpenSearch 접근 허용 설정</h2>\n<ul>\n<li>DaemonSet에서 OpenSearch로 로그를 전송할 수 있도록 접근 허용 설정을 한다.</li>\n<li>${OPEN_SEARCH_MASTER_USER}, ${OPEN_SEARCH_MASTER_PASSWORD}는 OpenSearch의 master user 계정이다. 이 계정은 fine-grained access control을 활성화하고 master user를 생성하면 만들 수 있다.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token comment\"># 1) VPC 내부로 접속한다. 예를 들면, VPC 내 배스천 서버로 접속한다.</span>\n\n<span class=\"token comment\"># 2) 변수 설정</span>\n<span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">CLUSTER_NAME</span><span class=\"token operator\">=</span>logging-test-eks\n<span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">LOGGING_ROLE</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span>kubectl get sa fluent-bit -n logging -o json <span class=\"token operator\">|</span>jq <span class=\"token string\">'.metadata.annotations.\"eks.amazonaws.com/role-arn\"'</span> -r<span class=\"token variable\">)</span></span>\n<span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">OPEN_SEARCH_ENDPOINT</span><span class=\"token operator\">=</span>https://vpc-logging-test-abcdefghijklmnopqrstuvwxyz.ap-southeast-1.es.amazonaws.com\n<span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">OPEN_SEARCH_MASTER_USER</span><span class=\"token operator\">=</span>XXXXXX\n<span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">OPEN_SEARCH_MASTER_PASSWORD</span><span class=\"token operator\">=</span>XXXXXX\n\n<span class=\"token comment\"># 3) OpenSearch Internal Database 업데이트</span>\n<span class=\"token function\">curl</span> -sS -u <span class=\"token string\">\"<span class=\"token variable\">${OPEN_SEARCH_MASTER_USER}</span>:<span class=\"token variable\">${OPEN_SEARCH_MASTER_PASSWORD}</span>\"</span> <span class=\"token punctuation\">\\</span>\n    -X PATCH https://<span class=\"token variable\">${OPEN_SEARCH_ENDPOINT}</span>/_opendistro/_security/api/rolesmapping/all_access?pretty <span class=\"token punctuation\">\\</span>\n    -H <span class=\"token string\">'Content-Type: application/json'</span> <span class=\"token punctuation\">\\</span>\n    -d <span class=\"token string\">'[{\"op\": \"add\", \"path\": \"/backend_roles\", \"value\": [ \"'</span><span class=\"token variable\">${LOGGING_ROLE}</span><span class=\"token string\">'\" ]}]'</span></code></pre></div>\n<h2>K8S ConfigMap 생성</h2>\n<ul>\n<li>${OPENSEARCH_ENDPOINT}, ${AWS_REGION}, ${INDEX_NAME} 값은 데몬셋 컨테이너의 환경 변수에서 설정한다.</li>\n</ul>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> ConfigMap\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">k8s-app</span><span class=\"token punctuation\">:</span> fluent<span class=\"token punctuation\">-</span>bit\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> fluent<span class=\"token punctuation\">-</span>bit<span class=\"token punctuation\">-</span>config\n  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> logging\n<span class=\"token key atrule\">data</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">fluent-bit.conf</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\"></span>\n<span class=\"token scalar string\">    [SERVICE]</span>\n<span class=\"token scalar string\">        Flush         1</span>\n<span class=\"token scalar string\">        Log_Level     info</span>\n<span class=\"token scalar string\">        Daemon        off</span>\n<span class=\"token scalar string\">        Parsers_File  parsers.conf</span>\n<span class=\"token scalar string\">        HTTP_Server   On</span>\n<span class=\"token scalar string\">        HTTP_Listen   0.0.0.0</span>\n<span class=\"token scalar string\">        HTTP_Port     2020</span>\n\n    @INCLUDE input<span class=\"token punctuation\">-</span>kubernetes.conf\n    @INCLUDE filter<span class=\"token punctuation\">-</span>kubernetes.conf\n    @INCLUDE output<span class=\"token punctuation\">-</span>opensearch.conf\n  \n  <span class=\"token key atrule\">input-kubernetes.conf</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\"></span>\n<span class=\"token scalar string\">    [INPUT]</span>\n<span class=\"token scalar string\">        Name              tail</span>\n<span class=\"token scalar string\">        Tag               kube.*</span>\n<span class=\"token scalar string\">        Path              /var/log/containers/*.log</span>\n<span class=\"token scalar string\">        Parser            docker</span>\n<span class=\"token scalar string\">        DB                /var/log/flb_kube.db</span>\n<span class=\"token scalar string\">        Mem_Buf_Limit     5MB</span>\n<span class=\"token scalar string\">        Skip_Long_Lines   On</span>\n<span class=\"token scalar string\">        Refresh_Interval  10</span>\n  \n  <span class=\"token key atrule\">filter-kubernetes.conf</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\"></span>\n<span class=\"token scalar string\">    [FILTER]</span>\n<span class=\"token scalar string\">        Name                kubernetes</span>\n<span class=\"token scalar string\">        Match               kube.*</span>\n<span class=\"token scalar string\">        Kube_URL            https://kubernetes.default.svc:443</span>\n<span class=\"token scalar string\">        Kube_CA_File        /var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span>\n<span class=\"token scalar string\">        Kube_Token_File     /var/run/secrets/kubernetes.io/serviceaccount/token</span>\n<span class=\"token scalar string\">        Kube_Tag_Prefix     kube.var.log.containers.</span>\n<span class=\"token scalar string\">        Merge_Log           On</span>\n<span class=\"token scalar string\">        Merge_Log_Key       log_processed</span>\n<span class=\"token scalar string\">        K8S-Logging.Parser  On</span>\n<span class=\"token scalar string\">        K8S-Logging.Exclude On</span>\n  \n  <span class=\"token key atrule\">output-opensearch.conf</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\"></span>\n<span class=\"token scalar string\">    [OUTPUT]</span>\n<span class=\"token scalar string\">        Name            es</span>\n<span class=\"token scalar string\">        Match           *</span>\n<span class=\"gatsby-highlight-code-line\"><span class=\"token scalar string\">        Host            ${OPENSEARCH_ENDPOINT}</span></span><span class=\"token scalar string\">        Port            443</span>\n<span class=\"token scalar string\">        TLS             On</span>\n<span class=\"token scalar string\">        AWS_Auth        On</span>\n<span class=\"gatsby-highlight-code-line\"><span class=\"token scalar string\">        AWS_Region      ${AWS_REGION}</span></span><span class=\"gatsby-highlight-code-line\"><span class=\"token scalar string\">        Index           ${INDEX_NAME}</span></span><span class=\"token scalar string\">        Replace_Dots    On</span>\n<span class=\"token scalar string\">        </span>\n  <span class=\"token key atrule\">parsers.conf</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\"></span>\n<span class=\"token scalar string\">    [PARSER]</span>\n<span class=\"token scalar string\">        Name        docker</span>\n<span class=\"token scalar string\">        Format      json</span>\n<span class=\"token scalar string\">        Time_Key    time</span>\n<span class=\"token scalar string\">        Time_Format %Y-%m-%dT%H:%M:%S.%L</span>\n<span class=\"token scalar string\">        Time_Keep   On</span></code></pre></div>\n<h2>K8S DaemonSet 생성</h2>\n<ul>\n<li><a href=\"https://oflouis.dev/sw_development/devops/aws-eks-application-logging-02/\">2편</a>에서 생성한 Service Account 이름을 spec.template.spec.ServiceAccountName에 적어준다.</li>\n</ul>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> apps/v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> DaemonSet\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">k8s-app</span><span class=\"token punctuation\">:</span> fluent<span class=\"token punctuation\">-</span>bit<span class=\"token punctuation\">-</span>logging\n    <span class=\"token key atrule\">kubernetes.io/cluster-service</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"true\"</span>\n    <span class=\"token key atrule\">version</span><span class=\"token punctuation\">:</span> v1\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> fluent<span class=\"token punctuation\">-</span>bit\n  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> logging\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">selector</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">matchLabels</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">k8s-app</span><span class=\"token punctuation\">:</span> fluent<span class=\"token punctuation\">-</span>bit<span class=\"token punctuation\">-</span>logging\n  <span class=\"token key atrule\">template</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">annotations</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">prometheus.io/path</span><span class=\"token punctuation\">:</span> /api/v1/metrics/prometheus\n        <span class=\"token key atrule\">prometheus.io/port</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"2020\"</span>\n        <span class=\"token key atrule\">prometheus.io/scrape</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"true\"</span>\n      <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">k8s-app</span><span class=\"token punctuation\">:</span> fluent<span class=\"token punctuation\">-</span>bit<span class=\"token punctuation\">-</span>logging\n        <span class=\"token key atrule\">kubernetes.io/cluster-service</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"true\"</span>\n        <span class=\"token key atrule\">version</span><span class=\"token punctuation\">:</span> v1\n    <span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">containers</span><span class=\"token punctuation\">:</span>\n<span class=\"gatsby-highlight-code-line\">      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">env</span><span class=\"token punctuation\">:</span></span><span class=\"gatsby-highlight-code-line\">        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> OPENSEARCH_ENDPOINT</span><span class=\"gatsby-highlight-code-line\">          <span class=\"token key atrule\">value</span><span class=\"token punctuation\">:</span> vpc<span class=\"token punctuation\">-</span>logging<span class=\"token punctuation\">-</span>test<span class=\"token punctuation\">-</span>abcdefghijklmnopqrstuvwxyz.ap<span class=\"token punctuation\">-</span>southeast<span class=\"token punctuation\">-</span>1.es.amazonaws.com</span><span class=\"gatsby-highlight-code-line\">        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> AWS_REGION</span><span class=\"gatsby-highlight-code-line\">          <span class=\"token key atrule\">value</span><span class=\"token punctuation\">:</span> ap<span class=\"token punctuation\">-</span>southeast<span class=\"token punctuation\">-</span><span class=\"token number\">1</span></span><span class=\"gatsby-highlight-code-line\">        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> INDEX_NAME</span><span class=\"gatsby-highlight-code-line\">          <span class=\"token key atrule\">value</span><span class=\"token punctuation\">:</span> eks<span class=\"token punctuation\">-</span>log</span>        <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> fluent<span class=\"token punctuation\">-</span>bit\n<span class=\"gatsby-highlight-code-line\">        <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> amazon/aws<span class=\"token punctuation\">-</span>for<span class=\"token punctuation\">-</span>fluent<span class=\"token punctuation\">-</span>bit<span class=\"token punctuation\">:</span>2.28.0</span>        <span class=\"token key atrule\">imagePullPolicy</span><span class=\"token punctuation\">:</span> Always\n        <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">containerPort</span><span class=\"token punctuation\">:</span> <span class=\"token number\">2020</span>\n        <span class=\"token key atrule\">volumeMounts</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">mountPath</span><span class=\"token punctuation\">:</span> /var/log\n          <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> varlog\n        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">mountPath</span><span class=\"token punctuation\">:</span> /var/lib/docker/containers\n          <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> varlibdockercontainers\n          <span class=\"token key atrule\">readOnly</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">mountPath</span><span class=\"token punctuation\">:</span> /fluent<span class=\"token punctuation\">-</span>bit/etc/\n          <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> fluent<span class=\"token punctuation\">-</span>bit<span class=\"token punctuation\">-</span>config\n<span class=\"gatsby-highlight-code-line\">      <span class=\"token key atrule\">serviceAccountName</span><span class=\"token punctuation\">:</span> fluent<span class=\"token punctuation\">-</span>bit</span>      <span class=\"token key atrule\">terminationGracePeriodSeconds</span><span class=\"token punctuation\">:</span> <span class=\"token number\">10</span>\n      <span class=\"token key atrule\">tolerations</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">effect</span><span class=\"token punctuation\">:</span> NoSchedule\n        <span class=\"token key atrule\">key</span><span class=\"token punctuation\">:</span> node<span class=\"token punctuation\">-</span>role.kubernetes.io/master\n        <span class=\"token key atrule\">operator</span><span class=\"token punctuation\">:</span> Exists\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">effect</span><span class=\"token punctuation\">:</span> NoExecute\n        <span class=\"token key atrule\">operator</span><span class=\"token punctuation\">:</span> Exists\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">effect</span><span class=\"token punctuation\">:</span> NoSchedule\n        <span class=\"token key atrule\">operator</span><span class=\"token punctuation\">:</span> Exists\n      <span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">hostPath</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> /var/log\n        <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> varlog\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">hostPath</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> /var/lib/docker/containers\n        <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> varlibdockercontainers\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">configMap</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> fluent<span class=\"token punctuation\">-</span>bit<span class=\"token punctuation\">-</span>config\n        <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> fluent<span class=\"token punctuation\">-</span>bit<span class=\"token punctuation\">-</span>config</code></pre></div>\n<h1>참고</h1>\n<hr>\n<ul>\n<li><a href=\"https://www.eksworkshop.com/intermediate/230_logging/deploy.files/fluentbit.yaml\">https://www.eksworkshop.com/intermediate/230_logging/deploy.files/fluentbit.yaml</a></li>\n</ul>","fields":{"slug":"/sw_development/devops/aws-eks-application-logging-03/"},"frontmatter":{"title":"AWS. EKS 애플리케이션 로그 수집하기 (3)","searchTexts":["AWS EKS 로그 수집","AWS OpenSearch에 Kubernetes 로그 수집","EKS와 Fluent Bit, OpenSearch 로그 수집"],"category":"sw development","subCategory":"devops","tags":["AWS","Kubernetes","K8S","OpenSearch","Logging","EKS","EFK"],"created":"Sep 11, 2022","updated":"Oct 15, 2022"},"tableOfContents":"<ul>\n<li>\n<p><a href=\"#%ED%8C%8C%ED%8A%B8-%EB%AA%A9%EC%B0%A8\">파트 목차</a></p>\n</li>\n<li>\n<p><a href=\"#fluent-bit-daemonset-%EC%84%A4%EC%A0%95\">Fluent Bit DaemonSet 설정</a></p>\n<ul>\n<li><a href=\"#opensearch-%EC%A0%91%EA%B7%BC-%ED%97%88%EC%9A%A9-%EC%84%A4%EC%A0%95\">OpenSearch 접근 허용 설정</a></li>\n<li><a href=\"#k8s-configmap-%EC%83%9D%EC%84%B1\">K8S ConfigMap 생성</a></li>\n<li><a href=\"#k8s-daemonset-%EC%83%9D%EC%84%B1\">K8S DaemonSet 생성</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%EC%B0%B8%EA%B3%A0\">참고</a></p>\n</li>\n</ul>"}},"pageContext":{"slug":"/sw_development/devops/aws-eks-application-logging-03/","prev":{"fields":{"slug":"/sw_development/devops/aws-eks-application-logging-02/"},"frontmatter":{"title":"AWS. EKS 애플리케이션 로그 수집하기 (2)","tags":["AWS","Kubernetes","K8S","OpenSearch","Logging","EKS","EFK"],"category":"sw development","subCategory":"devops"}},"next":{"fields":{"slug":"/sw_development/devops/aws-eks-application-logging-05/"},"frontmatter":{"title":"AWS. EKS 애플리케이션 로그 수집하기 (5)","tags":["AWS","Kubernetes","K8S","OpenSearch","Logging","EKS","EFK"],"category":"sw development","subCategory":"devops"}}}},"staticQueryHashes":["2152785458","3427181268"]}