{"componentChunkName":"component---src-templates-post-template-js","path":"/sw_development/devops/aws-eks-ebs-csi-installation/","result":{"data":{"site":{"siteMetadata":{"title":"Louis","author":"Louis"}},"markdownRemark":{"id":"a5b05b02-5468-552e-a5ba-66db0bd583d0","excerpt":"파드 사이에 데이터를 공유하고 파드의 라이프사이클에 영향없이 데이터가 유지되길 원한다면 퍼시스턴트 볼륨을 사용해야 한다. 본 포스팅은 AWS EKS가 이미 설치된 상황을 가정하고 설명한다.","html":"<p>파드 사이에 데이터를 공유하고 파드의 라이프사이클에 영향없이 데이터가 유지되길 원한다면 퍼시스턴트 볼륨을 사용해야 한다.</p>\n<p>본 포스팅은 AWS EKS가 이미 설치된 상황을 가정하고 설명한다.</p>\n<!-- more -->\n<h1>K8S Volume</h1>\n<hr>\n<h2>기본 개념</h2>\n<ul>\n<li>볼륨은 독립적인 K8S 오브젝트가 아니다. 따라서 자체적으로 생성/삭제하는 것은 불가능하다.</li>\n<li>볼륨은 파드의 구성요소이고 파드와 동일한 라이프 사이클을 가진다.\n<ul>\n<li>그렇다면 파드가 삭제될 때 볼륨의 콘텐츠도 삭제될까? 답은 볼륨의 유형에 따라 다르다.</li>\n</ul>\n</li>\n<li>볼륨의 유형으로는 emptyDir, hostPath, gitRepo, nfs, cloud(gcePersistentDisk, awsElasticBlockStore, azureDisk), ConfigMap, Secret, PersistentVolumeClaim 등이 있고, 목적에 따라 사용된다.</li>\n<li>파드는 동시에 복수의 볼륨을 사용할 수 있다.</li>\n</ul>\n<h2>퍼시스턴트 스토리지</h2>\n<ul>\n<li>볼륨의 데이터 유지가 필요하다면 퍼시스턴트 타입의 볼륨을 사용해야 한다.</li>\n<li>방법 1 : 퍼시스턴트 디스크를 생성 > 파드에서 볼륨 생성(생성된 디스크를 참조)하고 사용</li>\n<li>방법 2 : 퍼시스턴트 볼륨(들)을 생성 > 퍼시스턴트볼륨클레임 생성 > 파드에서 볼륨 생성(생성된 퍼시스턴트볼륨클레임 참조)하고 사용</li>\n<li>방법 3 : 퍼시스턴트 프로비저너 생성 > 스토리지클래스(들) 생성 > 퍼시스턴트볼륨클레임 생성(생성된 스토리지클래스를 참조) > 파드에서 볼륨 생성(생성된 퍼시스턴트볼륨클레임 참조)하고 사용\n<ul>\n<li>동적 프로비저닝 방식</li>\n</ul>\n</li>\n</ul>\n<h1>동적 프로비저닝을 위한 CSI Driver 설치</h1>\n<hr>\n<h2>IRSA 설정</h2>\n<ul>\n<li>OIDC identity provider 생성 (참고 : <a href=\"https://docs.aws.amazon.com/eks/latest/userguide/enable-iam-roles-for-service-accounts.html\">https://docs.aws.amazon.com/eks/latest/userguide/enable-iam-roles-for-service-accounts.html</a>)</li>\n<li>Role 생성\n<ul>\n<li>Trusted entity type : Web Identity</li>\n<li>Identity Provider : EKS의 OIDC Provider를 선택</li>\n<li>Audience : sts.amazonaws.com</li>\n<li>Permissions policies : AmazonEBSCSIDriverPolicy</li>\n<li>Trust Relationship 내용 수정\n<ul>\n<li>${IDENTITY_PROVIDER_ARN} : 위에서 생성한 EKS OIDC Provider ARN 값을 사용 (예 : arn:aws:iam::111122223333:oidc-provider/oidc.eks.region-code.amazonaws.com/id/EXAMPLED539D4633E53DE1B71EXAMPLE)</li>\n<li>${IDENTITY_PROVIDER} : EKS의 OIDC Provider 값을 사용 (예 : oidc.eks.region-code.amazonaws.com/id/EXAMPLED539D4633E53DE1B71EXAMPLE)</li>\n<li>${SERVICE_ACCOUNT_NAME} : 생성할 Service Account 정보를 기입 (예 : system:serviceaccount:kube-system:ebs-csi-controller)</li>\n</ul>\n<div class=\"gatsby-code-title gatsby-code-title-custom\">trust-relationship</div>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"Version\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"2012-10-17\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"Statement\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token punctuation\">{</span>\n            <span class=\"token property\">\"Effect\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Allow\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token property\">\"Principal\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n<span class=\"gatsby-highlight-code-line\">                <span class=\"token property\">\"Federated\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"${IDENTITY_PROVIDER_ARN}\"</span></span>            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n            <span class=\"token property\">\"Action\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"sts:AssumeRoleWithWebIdentity\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token property\">\"Condition\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token property\">\"StringEquals\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n<span class=\"gatsby-highlight-code-line\">                    <span class=\"token property\">\"${IDENTITY_PROVIDER}:aud\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"sts.amazonaws.com\"</span><span class=\"token punctuation\">,</span></span><span class=\"gatsby-highlight-code-line\">                    <span class=\"token property\">\"${IDENTITY_PROVIDER}:sub\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"${SERVICE_ACCOUNT_NAME}\"</span><span class=\"token punctuation\">,</span></span>                <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n</li>\n</ul>\n</li>\n<li>Service Account 생성\n<ul>\n<li>${IAM_ROLE_ARN} : 위에서 생성한 Role ARN (예 : arn:aws:iam::111122223333:role/eks-ebs-csi-driver-role)</li>\n</ul>\n<div class=\"gatsby-code-title gatsby-code-title-custom\">service-account.yaml</div>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> ServiceAccount\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n<span class=\"gatsby-highlight-code-line\">  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> ebs<span class=\"token punctuation\">-</span>csi<span class=\"token punctuation\">-</span>controller</span>  <span class=\"token key atrule\">annotations</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">eks.amazonaws.com/role-arn</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span>IAM_ROLE_ARN<span class=\"token punctuation\">}</span>\n  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> kube<span class=\"token punctuation\">-</span>system</code></pre></div>\n</li>\n</ul>\n<h2>EBS CSI Driver 설치</h2>\n<p>Driver 설치할 때 위에서 생성한 service account를 사용하도록 설정한다.</p>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">helm repo <span class=\"token function\">add</span> aws-ebs-csi-driver https://kubernetes-sigs.github.io/aws-ebs-csi-driver\nhelm repo update\n\n<span class=\"gatsby-highlight-code-line\">helm upgrade --install aws-ebs-csi-driver --namespace kube-system aws-ebs-csi-driver/aws-ebs-csi-driver <span class=\"token punctuation\">\\</span></span><span class=\"gatsby-highlight-code-line\">  --set controller.serviceAccount.create<span class=\"token operator\">=</span>false <span class=\"token punctuation\">\\</span></span><span class=\"gatsby-highlight-code-line\">  --set controller.serviceAccount.name<span class=\"token operator\">=</span>ebs-csi-controller</span></code></pre></div>\n<h2>StorageClass 확인 및 생성</h2>\n<ul>\n<li>EKS 서비스를 띄우면 한 개의 StorageClass가 이미 생성되어 있다.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">$ kubectl get sc\nNAME            PROVISIONER             RECLAIMPOLICY   VOLUMEBINDINGMODE      ALLOWVOLUMEEXPANSION   AGE\ngp2 <span class=\"token punctuation\">(</span>default<span class=\"token punctuation\">)</span>   kubernetes.io/aws-ebs   Delete          WaitForFirstConsumer   <span class=\"token boolean\">false</span>                  40d</code></pre></div>\n<ul>\n<li>다른 유형의 스토리지가 필요하다면 추가로 생성한다.</li>\n</ul>\n<div class=\"gatsby-code-title gatsby-code-title-custom\">storageclass-example</div>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> storage.k8s.io/v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> StorageClass\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n<span class=\"token comment\">#  annotations:</span>\n<span class=\"token comment\">#    storageclass.kubernetes.io/is-default-class: \"true\"</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> gp3\n<span class=\"token key atrule\">parameters</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">fsType</span><span class=\"token punctuation\">:</span> ext4\n  <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> gp3\n<span class=\"token key atrule\">provisioner</span><span class=\"token punctuation\">:</span> kubernetes.io/aws<span class=\"token punctuation\">-</span>ebs\n<span class=\"token key atrule\">reclaimPolicy</span><span class=\"token punctuation\">:</span> Delete\n<span class=\"token key atrule\">volumeBindingMode</span><span class=\"token punctuation\">:</span> WaitForFirstConsumer</code></pre></div>\n<h1>퍼시스턴트볼륨클레임 생성과 사용하기</h1>\n<hr>\n<h2>퍼시스턴트볼륨클레임</h2>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> PersistentVolumeClaim\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> playground<span class=\"token punctuation\">-</span>storage<span class=\"token punctuation\">-</span>pvc\n  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> playground\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">accessModes</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> ReadWriteOnce\n  <span class=\"token key atrule\">resources</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">requests</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">storage</span><span class=\"token punctuation\">:</span> 1Gi\n<span class=\"gatsby-highlight-code-line\">  <span class=\"token key atrule\">storageClassName</span><span class=\"token punctuation\">:</span> gp2</span></code></pre></div>\n<h2>파드</h2>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Pod\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> foo<span class=\"token punctuation\">-</span>app\n  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> playground\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">containers</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> registry.k8s.io/test<span class=\"token punctuation\">-</span>webserver\n    <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> playground<span class=\"token punctuation\">-</span>app<span class=\"token punctuation\">-</span>container\n    <span class=\"token key atrule\">volumeMounts</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">mountPath</span><span class=\"token punctuation\">:</span> /data\n      <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> playground<span class=\"token punctuation\">-</span>storage\n  <span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> playground<span class=\"token punctuation\">-</span>storage\n    <span class=\"token key atrule\">persistentVolumeClaim</span><span class=\"token punctuation\">:</span>\n<span class=\"gatsby-highlight-code-line\">      <span class=\"token key atrule\">claimName</span><span class=\"token punctuation\">:</span> playground<span class=\"token punctuation\">-</span>storage<span class=\"token punctuation\">-</span>pvc</span></code></pre></div>\n<h1>참고</h1>\n<hr>\n<ul>\n<li><a href=\"https://kubernetes-csi.github.io/docs/introduction.html\">https://kubernetes-csi.github.io/docs/introduction.html</a></li>\n<li><a href=\"https://docs.aws.amazon.com/eks/latest/userguide/ebs-csi.html\">https://docs.aws.amazon.com/eks/latest/userguide/ebs-csi.html</a></li>\n<li><a href=\"https://docs.aws.amazon.com/eks/latest/userguide/csi-iam-role.html\">https://docs.aws.amazon.com/eks/latest/userguide/csi-iam-role.html</a></li>\n<li><a href=\"https://github.com/kubernetes-sigs/aws-ebs-csi-driver/blob/master/docs/install.md\">https://github.com/kubernetes-sigs/aws-ebs-csi-driver/blob/master/docs/install.md</a></li>\n<li><a href=\"https://aws.amazon.com/premiumsupport/knowledge-center/eks-persistent-storage/?nc1=h_ls\">https://aws.amazon.com/premiumsupport/knowledge-center/eks-persistent-storage/?nc1=h_ls</a></li>\n</ul>","fields":{"slug":"/sw_development/devops/aws-eks-ebs-csi-installation/"},"frontmatter":{"title":"AWS EKS 퍼시스턴트볼륨 사용하기","searchTexts":["AWS EKS K8S PVC PV","AWS EBS CSI Driver installation","EKS 퍼시스턴트볼륨 사용 드라이버 설치하기"],"category":"sw development","subCategory":"devops","tags":["Kubernetes","K8S","AWS","EKS"],"created":"Oct 02, 2022","updated":"Oct 15, 2022"},"tableOfContents":"<ul>\n<li>\n<p><a href=\"#k8s-volume\">K8S Volume</a></p>\n<ul>\n<li><a href=\"#%EA%B8%B0%EB%B3%B8-%EA%B0%9C%EB%85%90\">기본 개념</a></li>\n<li><a href=\"#%ED%8D%BC%EC%8B%9C%EC%8A%A4%ED%84%B4%ED%8A%B8-%EC%8A%A4%ED%86%A0%EB%A6%AC%EC%A7%80\">퍼시스턴트 스토리지</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%EB%8F%99%EC%A0%81-%ED%94%84%EB%A1%9C%EB%B9%84%EC%A0%80%EB%8B%9D%EC%9D%84-%EC%9C%84%ED%95%9C-csi-driver-%EC%84%A4%EC%B9%98\">동적 프로비저닝을 위한 CSI Driver 설치</a></p>\n<ul>\n<li><a href=\"#irsa-%EC%84%A4%EC%A0%95\">IRSA 설정</a></li>\n<li><a href=\"#ebs-csi-driver-%EC%84%A4%EC%B9%98\">EBS CSI Driver 설치</a></li>\n<li><a href=\"#storageclass-%ED%99%95%EC%9D%B8-%EB%B0%8F-%EC%83%9D%EC%84%B1\">StorageClass 확인 및 생성</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%ED%8D%BC%EC%8B%9C%EC%8A%A4%ED%84%B4%ED%8A%B8%EB%B3%BC%EB%A5%A8%ED%81%B4%EB%A0%88%EC%9E%84-%EC%83%9D%EC%84%B1%EA%B3%BC-%EC%82%AC%EC%9A%A9%ED%95%98%EA%B8%B0\">퍼시스턴트볼륨클레임 생성과 사용하기</a></p>\n<ul>\n<li><a href=\"#%ED%8D%BC%EC%8B%9C%EC%8A%A4%ED%84%B4%ED%8A%B8%EB%B3%BC%EB%A5%A8%ED%81%B4%EB%A0%88%EC%9E%84\">퍼시스턴트볼륨클레임</a></li>\n<li><a href=\"#%ED%8C%8C%EB%93%9C\">파드</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%EC%B0%B8%EA%B3%A0\">참고</a></p>\n</li>\n</ul>"}},"pageContext":{"slug":"/sw_development/devops/aws-eks-ebs-csi-installation/","prev":{"fields":{"slug":"/sw_development/devops/aws-eks-monitoring-kube-prometheus-stack/"},"frontmatter":{"title":"AWS EKS 프로메테우스 그라파나 모니터링 구축하기","tags":["Kubernetes","K8S","AWS","EKS","Monitoring","Prometheus","Grafana"],"category":"sw development","subCategory":"devops"}},"next":{"fields":{"slug":"/sw_development/database/mysql-character-set-and-collation/"},"frontmatter":{"title":"MySQL 캐릭터셋 설정하기","tags":["mysql","ddl"],"category":"sw development","subCategory":"database"}}}},"staticQueryHashes":["2152785458","3427181268"]}