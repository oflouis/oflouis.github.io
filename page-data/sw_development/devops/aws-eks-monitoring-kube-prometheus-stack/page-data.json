{"componentChunkName":"component---src-templates-post-template-js","path":"/sw_development/devops/aws-eks-monitoring-kube-prometheus-stack/","result":{"data":{"site":{"siteMetadata":{"title":"Louis","author":"Louis"}},"markdownRemark":{"id":"cd0011c8-e133-57b8-ad85-1bdc64c40f16","excerpt":"AWS EKS 모니터링을 위해 kube-prometheus-stack을 설치했다. 그라파나는 다른 개발자들도 접속할 수 있도록 LB와 HTTPS 설정을 했고, 프로메테우스와 그라파나의 저장공간은 클러스터의 리소스를 사용하지 않게 AWS EBS 추가 설정을 했다. 본 포스팅은 AWS EKS가 이미 설치된 상황을 가정하고 설명한다.","html":"<p>AWS EKS 모니터링을 위해 kube-prometheus-stack을 설치했다. 그라파나는 다른 개발자들도 접속할 수 있도록 LB와 HTTPS 설정을 했고, 프로메테우스와 그라파나의 저장공간은 클러스터의 리소스를 사용하지 않게 AWS EBS 추가 설정을 했다.</p>\n<p>본 포스팅은 AWS EKS가 이미 설치된 상황을 가정하고 설명한다.</p>\n<!-- more -->\n<h1>kube-prometheus 란?</h1>\n<hr>\n<ul>\n<li>kube-prometheus 프로젝트는 쿠버네티스 클러스터를 모니터링하기 위한 것으로, 모든 쿠버네티스 컴포넌트들의 매트릭스를 수집하도록 사전 설정되었고 추가로 대시보드와 알림 규칙의 기본 세트를 제공한다.</li>\n<li>이 프로젝트가 포함하는 컴포넌트는 다음과 같다.\n<ul>\n<li>The Prometheus Operator</li>\n<li>Highly available Prometheus</li>\n<li>Highly available Alertmanager</li>\n<li>Prometheus node-exporter</li>\n<li>Prometheus Adapter for Kubernetes Metrics APIs</li>\n<li>kube-state-metrics</li>\n<li>Grafana</li>\n</ul>\n</li>\n<li>Helm Chart 이름은 kube-prometheus-stack이고, 이전 이름은 prometheus-operator 였다.</li>\n</ul>\n<h1>설치하기</h1>\n<hr>\n<h2>설치 전 준비할 내용</h2>\n<ul>\n<li>AWS EKS 생성</li>\n<li>(선택 사항) AWS EKS 퍼시스턴트볼륨 동적프로비저닝 설정 (<a href=\"https://oflouis.dev/sw_development/devops/aws-eks-ebs-csi-installation/\">https://oflouis.dev/sw_development/devops/aws-eks-ebs-csi-installation/</a>)</li>\n<li>(선택 사항) ACM 인증서 준비</li>\n<li>(선택 사항) kube-prometheus-stack 설치 커스터마이징 파일</li>\n</ul>\n<h2>kube-prometheus-stack 설치 커스터마이징 파일</h2>\n<ul>\n<li>아래 커스터마이징 파일은 다음을 포함한다.\n<ul>\n<li>그라파나 서버 접속 HTTPS 적용</li>\n<li>그라파나와 프로메테우스 영구 저장소 설정</li>\n</ul>\n</li>\n</ul>\n<div class=\"gatsby-code-title gatsby-code-title-custom\">custom.yaml</div>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">alertmanager</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">service</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> NodePort\n<span class=\"token key atrule\">grafana</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">service</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">annotations</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">service.beta.kubernetes.io/aws-load-balancer-backend-protocol</span><span class=\"token punctuation\">:</span> http\n      <span class=\"token key atrule\">service.beta.kubernetes.io/aws-load-balancer-proxy-protocol</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'*'</span>\n      <span class=\"token key atrule\">service.beta.kubernetes.io/aws-load-balancer-ssl-cert</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span>ACM_CERT_ARN<span class=\"token punctuation\">}</span>\n      <span class=\"token key atrule\">service.beta.kubernetes.io/aws-load-balancer-ssl-ports</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'443'</span>\n    <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> LoadBalancer\n  <span class=\"token key atrule\">extraExposePorts</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> https\n      <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span> <span class=\"token number\">443</span>\n      <span class=\"token key atrule\">targetPort</span><span class=\"token punctuation\">:</span> <span class=\"token number\">3000</span>\n  <span class=\"token key atrule\">resources</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">limits</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">cpu</span><span class=\"token punctuation\">:</span> 200m\n      <span class=\"token key atrule\">memory</span><span class=\"token punctuation\">:</span> 256Mi\n    <span class=\"token key atrule\">requests</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">cpu</span><span class=\"token punctuation\">:</span> 100m\n      <span class=\"token key atrule\">memory</span><span class=\"token punctuation\">:</span> 128Mi\n  <span class=\"token key atrule\">persistence</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> pvc\n    <span class=\"token key atrule\">enabled</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n    <span class=\"token key atrule\">storageClassName</span><span class=\"token punctuation\">:</span> gp2\n    <span class=\"token key atrule\">accessModes</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> ReadWriteOnce\n    <span class=\"token key atrule\">size</span><span class=\"token punctuation\">:</span> 10Gi\n<span class=\"token key atrule\">prometheus</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">service</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> NodePort\n  <span class=\"token key atrule\">prometheusSpec</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">retention</span><span class=\"token punctuation\">:</span> 10d\n    <span class=\"token key atrule\">retentionSize</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"45GB\"</span>\n    <span class=\"token key atrule\">resources</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">limits</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">cpu</span><span class=\"token punctuation\">:</span> 500m\n        <span class=\"token key atrule\">memory</span><span class=\"token punctuation\">:</span> 512Mi\n      <span class=\"token key atrule\">requests</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">cpu</span><span class=\"token punctuation\">:</span> 200m\n        <span class=\"token key atrule\">memory</span><span class=\"token punctuation\">:</span> 256Mi\n    <span class=\"token key atrule\">storageSpec</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">volumeClaimTemplate</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">storageClassName</span><span class=\"token punctuation\">:</span> gp2\n          <span class=\"token key atrule\">accessModes</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"ReadWriteOnce\"</span><span class=\"token punctuation\">]</span>\n          <span class=\"token key atrule\">resources</span><span class=\"token punctuation\">:</span>\n            <span class=\"token key atrule\">requests</span><span class=\"token punctuation\">:</span>\n              <span class=\"token key atrule\">storage</span><span class=\"token punctuation\">:</span> 50Gi</code></pre></div>\n<h2>kube-prometheus-stack 설치하기</h2>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token comment\"># 헬름 차트의 저장소 추가</span>\nhelm repo <span class=\"token function\">add</span> prometheus-community https://prometheus-community.github.io/helm-charts\nhelm repo update\n\n<span class=\"token comment\"># 네임스페이스 생성</span>\nkubectl create ns monitoring\n\n<span class=\"token comment\"># kube-prometheus-stack 설치 </span>\nhelm <span class=\"token function\">install</span> prometheus-stack prometheus-community/kube-prometheus-stack -f ./custom.yaml -n monitoring\n\n<span class=\"token comment\"># 설치 확인 </span>\nkubectl get pods -l <span class=\"token string\">\"release=prometheus-stack\"</span> -n monitoring\nhelm get values prometheus-stack -n monitoring\nkubectl get pvc -n monitoring\nkubectl get <span class=\"token function\">pv</span> -n monitoring</code></pre></div>\n<ul>\n<li>추가 명령어</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token comment\"># kube-prometheus-stack 업데이트 하기</span>\nhelm upgrade prometheus-stack prometheus-community/kube-prometheus-stack -f ./custom.yaml -n monitoring\n\n<span class=\"token comment\"># kube-prometheus-stack 삭제하기</span>\nhelm uninstall prometheus-stack -n monitoring</code></pre></div>\n<h1>그라파나 접속하기</h1>\n<hr>\n<p>그라파나에 접속하기 위해 주소와 계정 정보를 확인한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token comment\"># 그라파나 접속 주소 확인하기</span>\nkubectl get svc prometheus-stack-grafana -o json -n monitoring <span class=\"token operator\">|</span>jq -r <span class=\"token string\">'.status.loadBalancer.ingress[0].hostname'</span>\n\n<span class=\"token comment\"># 그라파나 계정 확인하기</span>\nkubectl get secret prometheus-stack-grafana -o <span class=\"token assign-left variable\">jsonpath</span><span class=\"token operator\">=</span><span class=\"token string\">\"{.data.admin-user}\"</span> -n monitoring <span class=\"token operator\">|</span>base64 -d<span class=\"token punctuation\">;</span> <span class=\"token builtin class-name\">echo</span>\nkubectl get secret prometheus-stack-grafana -o <span class=\"token assign-left variable\">jsonpath</span><span class=\"token operator\">=</span><span class=\"token string\">\"{.data.admin-password}\"</span> -n monitoring <span class=\"token operator\">|</span>base64 -d<span class=\"token punctuation\">;</span> <span class=\"token builtin class-name\">echo</span></code></pre></div>\n<p>브라우저에서 그라파나에 접속하고 Dashboards와 Alerting 메뉴를 보면 디폴트들이 제공되어 있다.</p>\n<h1>Gist 에서 확인하기</h1>\n<hr>\n<ul>\n<li><a href=\"https://gist.github.com/oflouis/421443c6d5b608f80d291171452a41d5\">https://gist.github.com/oflouis/421443c6d5b608f80d291171452a41d5</a></li>\n</ul>\n<h1>참고</h1>\n<hr>\n<ul>\n<li><a href=\"https://github.com/prometheus-community/helm-charts/tree/main/charts/kube-prometheus-stack\">https://github.com/prometheus-community/helm-charts/tree/main/charts/kube-prometheus-stack</a></li>\n<li><a href=\"https://kubernetes-sigs.github.io/aws-load-balancer-controller/v2.4/guide/service/annotations/#proxy-protocol-v2\">https://kubernetes-sigs.github.io/aws-load-balancer-controller/v2.4/guide/service/annotations/#proxy-protocol-v2</a></li>\n</ul>","fields":{"slug":"/sw_development/devops/aws-eks-monitoring-kube-prometheus-stack/"},"frontmatter":{"title":"AWS. EKS 프로메테우스 그라파나 모니터링 구축하기","searchTexts":["AWS EKS Prometheus Grafana 모니터링 구축하기","EKS Prometheus Grafana HTTPS","EKS Prometheus Grafana 영구저장소 Persistent Storage 설정","EKS kube-prometheus-stack 설치"],"category":"sw development","subCategory":"devops","tags":["AWS","Kubernetes","K8S","AWS","EKS","Monitoring","Prometheus","Grafana"],"created":"Oct 09, 2022","updated":"Oct 15, 2022"},"tableOfContents":"<ul>\n<li>\n<p><a href=\"#kube-prometheus-%EB%9E%80\">kube-prometheus 란?</a></p>\n</li>\n<li>\n<p><a href=\"#%EC%84%A4%EC%B9%98%ED%95%98%EA%B8%B0\">설치하기</a></p>\n<ul>\n<li><a href=\"#%EC%84%A4%EC%B9%98-%EC%A0%84-%EC%A4%80%EB%B9%84%ED%95%A0-%EB%82%B4%EC%9A%A9\">설치 전 준비할 내용</a></li>\n<li><a href=\"#kube-prometheus-stack-%EC%84%A4%EC%B9%98-%EC%BB%A4%EC%8A%A4%ED%84%B0%EB%A7%88%EC%9D%B4%EC%A7%95-%ED%8C%8C%EC%9D%BC\">kube-prometheus-stack 설치 커스터마이징 파일</a></li>\n<li><a href=\"#kube-prometheus-stack-%EC%84%A4%EC%B9%98%ED%95%98%EA%B8%B0\">kube-prometheus-stack 설치하기</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%EA%B7%B8%EB%9D%BC%ED%8C%8C%EB%82%98-%EC%A0%91%EC%86%8D%ED%95%98%EA%B8%B0\">그라파나 접속하기</a></p>\n</li>\n<li>\n<p><a href=\"#gist-%EC%97%90%EC%84%9C-%ED%99%95%EC%9D%B8%ED%95%98%EA%B8%B0\">Gist 에서 확인하기</a></p>\n</li>\n<li>\n<p><a href=\"#%EC%B0%B8%EA%B3%A0\">참고</a></p>\n</li>\n</ul>"}},"pageContext":{"slug":"/sw_development/devops/aws-eks-monitoring-kube-prometheus-stack/","prev":{"fields":{"slug":"/sw_development/devops/aws-eks-monitoring-grafana/"},"frontmatter":{"title":"AWS. EKS 그라파나 알람 설정하기","tags":["AWS","Kubernetes","K8S","AWS","EKS","Monitoring","Grafana"],"category":"sw development","subCategory":"devops"}},"next":{"fields":{"slug":"/sw_development/devops/aws-eks-ebs-csi-installation/"},"frontmatter":{"title":"AWS. EKS 퍼시스턴트볼륨 사용하기","tags":["AWS","Kubernetes","K8S","AWS","EKS"],"category":"sw development","subCategory":"devops"}}}},"staticQueryHashes":["2152785458","3427181268"]}