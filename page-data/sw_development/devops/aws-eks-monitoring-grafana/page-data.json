{
    "componentChunkName": "component---src-templates-post-template-js",
    "path": "/sw_development/devops/aws-eks-monitoring-grafana/",
    "result": {"data":{"site":{"siteMetadata":{"title":"Louis","author":"Louis"}},"markdownRemark":{"id":"590dbfb6-e2ed-5e28-91f8-5833f0c9e226","excerpt":"AWS EKS 모니터링을 위해 kube-prometheus-stack를 설치하면 기본적인 설정은 끝났다. 하지만 사람이 여러 대시보드를 주시하고 모니터링을 24시간 실시간으로 할 수 없기 때문에 주요 지표에 대해서 알람 설정을 해주는 것이 필수이다. 그라파나에 알람 설정을 추가하고 슬랙으로 전송해보자. 본 포스팅은 AWS EKS와 kube-prometheus-stack이 이미 설치된 상황을 가정하고 설명한다.","html":"<p>AWS EKS 모니터링을 위해 kube-prometheus-stack를 설치하면 기본적인 설정은 끝났다. 하지만 사람이 여러 대시보드를 주시하고 모니터링을 24시간 실시간으로 할 수 없기 때문에 주요 지표에 대해서 알람 설정을 해주는 것이 필수이다. 그라파나에 알람 설정을 추가하고 슬랙으로 전송해보자.</p>\n<p>본 포스팅은 AWS EKS와 kube-prometheus-stack이 이미 설치된 상황을 가정하고 설명한다.</p>\n<!-- more -->\n<h1>준비하기</h1>\n<hr>\n<ul>\n<li>AWS EKS에 kube-prometheus-stack 설치하기 : <a href=\"https://oflouis.dev/sw_development/devops/aws-eks-monitoring-kube-prometheus-stack/\">https://oflouis.dev/sw_development/devops/aws-eks-monitoring-kube-prometheus-stack/</a></li>\n</ul>\n<h1>슬랙 알림 메세지 샘플 화면</h1>\n<hr>\n<p>설정 후 최종 알림 화면은 다음과 같다.\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 340px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/d197bf39f1256d60fc4c4b93e8e65230/d30a3/grafana-slack-message-example.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 83.1275720164609%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAARABQDASIAAhEBAxEB/8QAGAABAAMBAAAAAAAAAAAAAAAAAAECAwX/xAAUAQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIQAxAAAAHtaZ3JBFgkH//EABcQAQEBAQAAAAAAAAAAAAAAACEAEiD/2gAIAQEAAQUCys2Vnj//xAAUEQEAAAAAAAAAAAAAAAAAAAAg/9oACAEDAQE/AR//xAAUEQEAAAAAAAAAAAAAAAAAAAAg/9oACAECAQE/AR//xAAWEAADAAAAAAAAAAAAAAAAAAAQIDH/2gAIAQEABj8CNb//xAAfEAACAQIHAAAAAAAAAAAAAAAAARFRkRAhMUFhcYH/2gAIAQEAAT8hzancipHg5FzshVQb4//aAAwDAQACAAMAAAAQEM8A/8QAFBEBAAAAAAAAAAAAAAAAAAAAIP/aAAgBAwEBPxAf/8QAFBEBAAAAAAAAAAAAAAAAAAAAIP/aAAgBAgEBPxAf/8QAHhABAAICAQUAAAAAAAAAAAAAAQARIXFBEDFRYZH/2gAIAQEAAT8QQtF4yYAYTZA5vyxswPaZRMJsZg5PVx7uv//Z'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/d197bf39f1256d60fc4c4b93e8e65230/fc615/grafana-slack-message-example.avif 243w,\n/static/d197bf39f1256d60fc4c4b93e8e65230/5f1e1/grafana-slack-message-example.avif 340w\"\n              sizes=\"(max-width: 340px) 100vw, 340px\"\n              type=\"image/avif\"\n            /><source\n              srcset=\"/static/d197bf39f1256d60fc4c4b93e8e65230/0e3e2/grafana-slack-message-example.webp 243w,\n/static/d197bf39f1256d60fc4c4b93e8e65230/8ae5a/grafana-slack-message-example.webp 340w\"\n              sizes=\"(max-width: 340px) 100vw, 340px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/d197bf39f1256d60fc4c4b93e8e65230/3f316/grafana-slack-message-example.jpg 243w,\n/static/d197bf39f1256d60fc4c4b93e8e65230/d30a3/grafana-slack-message-example.jpg 340w\"\n            sizes=\"(max-width: 340px) 100vw, 340px\"\n            type=\"image/jpeg\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/d197bf39f1256d60fc4c4b93e8e65230/d30a3/grafana-slack-message-example.jpg\"\n            alt=\"슬랙 알림 메세지 샘플\"\n            title=\"슬랙 알림 메세지 샘플\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<h1>슬랙 알람 전송 설정</h1>\n<hr>\n<h2>슬랙 메세지 포맷 설정</h2>\n<ul>\n<li>Alerting > Contact points > New Template</li>\n<li>{{ .CommonLabels.xxx }}와 {{ .Annotations.summary }}의 내용은 각각의 알림에서 설정한다. alert.json 샘플을 참고하자.</li>\n</ul>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">{{ define \"slack.alert_title\" }}\n<span class=\"gatsby-highlight-code-line\">[ {{ .Status | toUpper }} ] {{ .CommonLabels.region | toUpper }} | {{ .CommonLabels.env | toUpper }} | {{ .CommonLabels.alertname }}</span>{{ end }}\n\n{{ define \"slack.alert_message\" }}\n{{ range .Alerts }}\n<span class=\"gatsby-highlight-code-line\">*Summary*: *{{ .Annotations.summary }}*</span>*Labels*:\n{{ range .Labels.SortedPairs }}{{ if or (eq .Name \"env\") (eq .Name \"app\") (eq .Name \"namespace\") (eq .Name \"instance\") }} *- {{ .Name }} = {{ .Value }}*{{end}}\n{{ end }}\n{{ end }}\n{{ end }}</code></pre></div>\n<h2>슬랙 연동 설정</h2>\n<ul>\n<li>슬랙 채널 만들기</li>\n<li>슬랙 앱 만들기\n<ul>\n<li>슬랙 앱 관리 화면에서 WebhookURL을 생성</li>\n</ul>\n</li>\n<li>Alerting > Contact points > New Contact point\n<ul>\n<li>Contact point type : Slack</li>\n<li>Webhook URL : Slack Webhook URL</li>\n<li>Optional Slack setting > Title : <strong>{{ template \"slack.alert_title\" . }}</strong></li>\n<li>Optional Slack setting > Text Body : <strong>{{ template \"slack.alert_message\" . }}</strong></li>\n<li>Optional Slack setting > Mention Users : 멘션할 슬랙 ID(들) 입력</li>\n</ul>\n</li>\n</ul>\n<h1>그라파나 알람 규칙 추가</h1>\n<hr>\n<p>본 포스팅에서는 그라파나의 <strong>Alerting Provisioning HTTP API</strong>를 사용하여 알람 규칙을 생성 및 관리하는 내용을 작성했다.\n프로비저닝 방식으로 생성한 경우 UI에서 생성하지 않았기 때문에 UI를 통한 수정 및 삭제는 불가능하니 참고하자.</p>\n<h2>환경변수 설정</h2>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">GRAFANA_USER_NAME</span><span class=\"token operator\">=</span>\n<span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">GRAFANA_USER_PASSWORD</span><span class=\"token operator\">=</span>\n<span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">GRAFANA_HOST_URL</span><span class=\"token operator\">=</span></code></pre></div>\n<h2>폴더 생성</h2>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token comment\"># 폴더 생성</span>\n<span class=\"token function\">curl</span> <span class=\"token parameter variable\">-X</span> POST http://<span class=\"token variable\">${GRAFANA_USER_NAME}</span><span class=\"token builtin class-name\">:</span><span class=\"token variable\">${GRAFANA_USER_PASSWORD}</span>@<span class=\"token variable\">${GRAFANA_HOST_URL}</span>/api/folders <span class=\"token punctuation\">\\</span>\n      <span class=\"token parameter variable\">-H</span> <span class=\"token string\">'content-type: application/json'</span> <span class=\"token punctuation\">\\</span>\n      <span class=\"token parameter variable\">-d</span> <span class=\"token string\">'{\"title\" : \"Service Monitoring\" }'</span>\n\n<span class=\"token comment\"># 폴더 UID 확인</span>\n<span class=\"token function\">curl</span> http://<span class=\"token variable\">${GRAFANA_USER_NAME}</span><span class=\"token builtin class-name\">:</span><span class=\"token variable\">${GRAFANA_USER_PASSWORD}</span>@<span class=\"token variable\">${GRAFANA_HOST_URL}</span>/api/folders <span class=\"token operator\">|</span>jq\n<span class=\"token punctuation\">[</span>\n  <span class=\"token punctuation\">{</span>\n    <span class=\"token string\">\"id\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token number\">111</span>,\n<span class=\"gatsby-highlight-code-line\">    <span class=\"token string\">\"uid\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"7KVKla2Ef\"</span>,</span>    <span class=\"token string\">\"title\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"Service Monitoring\"</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">..</span>.\n<span class=\"token punctuation\">]</span></code></pre></div>\n<h2>알람 규칙</h2>\n<ul>\n<li>규칙을 정의한 파일 생성 (샘플)</li>\n</ul>\n<div class=\"gatsby-code-title gatsby-code-title-custom\">alert.json</div>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"title\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"NodeHighCPU\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"orgID\"</span><span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"folderUID\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"7KVKla2Ef\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"ruleGroup\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Instance\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"condition\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"C\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"execErrState\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Alerting\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"noDataState\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"NoData\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"for\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"5m\"</span><span class=\"token punctuation\">,</span>\n<span class=\"gatsby-highlight-code-line\">  <span class=\"token property\">\"annotations\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">    <span class=\"token property\">\"summary\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"CPU Usage : {{ humanize $values.B.Value }} %, Node : {{ $labels.instance }}\"</span></span><span class=\"gatsby-highlight-code-line\">  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span></span><span class=\"gatsby-highlight-code-line\">  <span class=\"token property\">\"labels\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token property\">\"env\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"integ\"</span><span class=\"token punctuation\">,</span> <span class=\"token property\">\"region\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"kor\"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span></span>  <span class=\"token property\">\"data\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token punctuation\">{</span><span class=\"token property\">\"refId\"</span><span class=\"token operator\">:</span><span class=\"token string\">\"A\"</span><span class=\"token punctuation\">,</span><span class=\"token property\">\"queryType\"</span><span class=\"token operator\">:</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span><span class=\"token property\">\"relativeTimeRange\"</span><span class=\"token operator\">:</span><span class=\"token punctuation\">{</span><span class=\"token property\">\"from\"</span><span class=\"token operator\">:</span><span class=\"token number\">600</span><span class=\"token punctuation\">,</span><span class=\"token property\">\"to\"</span><span class=\"token operator\">:</span><span class=\"token number\">0</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span><span class=\"token property\">\"datasourceUid\"</span><span class=\"token operator\">:</span><span class=\"token string\">\"prometheus\"</span><span class=\"token punctuation\">,</span><span class=\"token property\">\"model\"</span><span class=\"token operator\">:</span><span class=\"token punctuation\">{</span><span class=\"token property\">\"editorMode\"</span><span class=\"token operator\">:</span><span class=\"token string\">\"code\"</span><span class=\"token punctuation\">,</span><span class=\"token property\">\"expr\"</span><span class=\"token operator\">:</span><span class=\"token string\">\"100 - (max by(instance) (irate(node_cpu_seconds_total{mode=\\\"idle\\\"}[5m])) * 100)\"</span><span class=\"token punctuation\">,</span><span class=\"token property\">\"hide\"</span><span class=\"token operator\">:</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span><span class=\"token property\">\"intervalMs\"</span><span class=\"token operator\">:</span><span class=\"token number\">1000</span><span class=\"token punctuation\">,</span><span class=\"token property\">\"legendFormat\"</span><span class=\"token operator\">:</span><span class=\"token string\">\"__auto\"</span><span class=\"token punctuation\">,</span><span class=\"token property\">\"maxDataPoints\"</span><span class=\"token operator\">:</span><span class=\"token number\">43200</span><span class=\"token punctuation\">,</span><span class=\"token property\">\"range\"</span><span class=\"token operator\">:</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span><span class=\"token property\">\"refId\"</span><span class=\"token operator\">:</span><span class=\"token string\">\"A\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">{</span><span class=\"token property\">\"refId\"</span><span class=\"token operator\">:</span><span class=\"token string\">\"B\"</span><span class=\"token punctuation\">,</span><span class=\"token property\">\"queryType\"</span><span class=\"token operator\">:</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span><span class=\"token property\">\"relativeTimeRange\"</span><span class=\"token operator\">:</span><span class=\"token punctuation\">{</span><span class=\"token property\">\"from\"</span><span class=\"token operator\">:</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token property\">\"to\"</span><span class=\"token operator\">:</span><span class=\"token number\">0</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span><span class=\"token property\">\"datasourceUid\"</span><span class=\"token operator\">:</span><span class=\"token string\">\"-100\"</span><span class=\"token punctuation\">,</span><span class=\"token property\">\"model\"</span><span class=\"token operator\">:</span><span class=\"token punctuation\">{</span><span class=\"token property\">\"conditions\"</span><span class=\"token operator\">:</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">{</span><span class=\"token property\">\"evaluator\"</span><span class=\"token operator\">:</span><span class=\"token punctuation\">{</span><span class=\"token property\">\"params\"</span><span class=\"token operator\">:</span><span class=\"token punctuation\">[</span><span class=\"token number\">3</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span><span class=\"token property\">\"type\"</span><span class=\"token operator\">:</span><span class=\"token string\">\"gt\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span><span class=\"token property\">\"operator\"</span><span class=\"token operator\">:</span><span class=\"token punctuation\">{</span><span class=\"token property\">\"type\"</span><span class=\"token operator\">:</span><span class=\"token string\">\"and\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span><span class=\"token property\">\"query\"</span><span class=\"token operator\">:</span><span class=\"token punctuation\">{</span><span class=\"token property\">\"params\"</span><span class=\"token operator\">:</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"A\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span><span class=\"token property\">\"reducer\"</span><span class=\"token operator\">:</span><span class=\"token punctuation\">{</span><span class=\"token property\">\"params\"</span><span class=\"token operator\">:</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span><span class=\"token property\">\"type\"</span><span class=\"token operator\">:</span><span class=\"token string\">\"last\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span><span class=\"token property\">\"type\"</span><span class=\"token operator\">:</span><span class=\"token string\">\"query\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span><span class=\"token property\">\"datasource\"</span><span class=\"token operator\">:</span><span class=\"token punctuation\">{</span><span class=\"token property\">\"type\"</span><span class=\"token operator\">:</span><span class=\"token string\">\"__expr__\"</span><span class=\"token punctuation\">,</span><span class=\"token property\">\"uid\"</span><span class=\"token operator\">:</span><span class=\"token string\">\"-100\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span><span class=\"token property\">\"expression\"</span><span class=\"token operator\">:</span><span class=\"token string\">\"A\"</span><span class=\"token punctuation\">,</span><span class=\"token property\">\"hide\"</span><span class=\"token operator\">:</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span><span class=\"token property\">\"intervalMs\"</span><span class=\"token operator\">:</span><span class=\"token number\">1000</span><span class=\"token punctuation\">,</span><span class=\"token property\">\"maxDataPoints\"</span><span class=\"token operator\">:</span><span class=\"token number\">43200</span><span class=\"token punctuation\">,</span><span class=\"token property\">\"reducer\"</span><span class=\"token operator\">:</span><span class=\"token string\">\"max\"</span><span class=\"token punctuation\">,</span><span class=\"token property\">\"refId\"</span><span class=\"token operator\">:</span><span class=\"token string\">\"B\"</span><span class=\"token punctuation\">,</span><span class=\"token property\">\"type\"</span><span class=\"token operator\">:</span><span class=\"token string\">\"reduce\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">{</span><span class=\"token property\">\"refId\"</span><span class=\"token operator\">:</span><span class=\"token string\">\"C\"</span><span class=\"token punctuation\">,</span><span class=\"token property\">\"queryType\"</span><span class=\"token operator\">:</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span><span class=\"token property\">\"relativeTimeRange\"</span><span class=\"token operator\">:</span><span class=\"token punctuation\">{</span><span class=\"token property\">\"from\"</span><span class=\"token operator\">:</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token property\">\"to\"</span><span class=\"token operator\">:</span><span class=\"token number\">0</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span><span class=\"token property\">\"datasourceUid\"</span><span class=\"token operator\">:</span><span class=\"token string\">\"-100\"</span><span class=\"token punctuation\">,</span><span class=\"token property\">\"model\"</span><span class=\"token operator\">:</span><span class=\"token punctuation\">{</span><span class=\"token property\">\"conditions\"</span><span class=\"token operator\">:</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">{</span><span class=\"token property\">\"evaluator\"</span><span class=\"token operator\">:</span><span class=\"token punctuation\">{</span><span class=\"token property\">\"params\"</span><span class=\"token operator\">:</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span><span class=\"token property\">\"type\"</span><span class=\"token operator\">:</span><span class=\"token string\">\"gt\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span><span class=\"token property\">\"operator\"</span><span class=\"token operator\">:</span><span class=\"token punctuation\">{</span><span class=\"token property\">\"type\"</span><span class=\"token operator\">:</span><span class=\"token string\">\"and\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span><span class=\"token property\">\"query\"</span><span class=\"token operator\">:</span><span class=\"token punctuation\">{</span><span class=\"token property\">\"params\"</span><span class=\"token operator\">:</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"B\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span><span class=\"token property\">\"reducer\"</span><span class=\"token operator\">:</span><span class=\"token punctuation\">{</span><span class=\"token property\">\"params\"</span><span class=\"token operator\">:</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span><span class=\"token property\">\"type\"</span><span class=\"token operator\">:</span><span class=\"token string\">\"avg\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span><span class=\"token property\">\"type\"</span><span class=\"token operator\">:</span><span class=\"token string\">\"query\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span><span class=\"token property\">\"datasource\"</span><span class=\"token operator\">:</span><span class=\"token punctuation\">{</span><span class=\"token property\">\"name\"</span><span class=\"token operator\">:</span><span class=\"token string\">\"Expression\"</span><span class=\"token punctuation\">,</span><span class=\"token property\">\"type\"</span><span class=\"token operator\">:</span><span class=\"token string\">\"__expr__\"</span><span class=\"token punctuation\">,</span><span class=\"token property\">\"uid\"</span><span class=\"token operator\">:</span><span class=\"token string\">\"__expr__\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span><span class=\"token property\">\"expression\"</span><span class=\"token operator\">:</span><span class=\"token string\">\"round($B) > 70\"</span><span class=\"token punctuation\">,</span><span class=\"token property\">\"hide\"</span><span class=\"token operator\">:</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span><span class=\"token property\">\"intervalMs\"</span><span class=\"token operator\">:</span><span class=\"token number\">1000</span><span class=\"token punctuation\">,</span><span class=\"token property\">\"maxDataPoints\"</span><span class=\"token operator\">:</span><span class=\"token number\">43200</span><span class=\"token punctuation\">,</span><span class=\"token property\">\"refId\"</span><span class=\"token operator\">:</span><span class=\"token string\">\"C\"</span><span class=\"token punctuation\">,</span><span class=\"token property\">\"type\"</span><span class=\"token operator\">:</span><span class=\"token string\">\"math\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>명령들</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token comment\"># 생성</span>\n<span class=\"token function\">curl</span> <span class=\"token parameter variable\">-X</span> POST http://<span class=\"token variable\">${GRAFANA_USER_NAME}</span><span class=\"token builtin class-name\">:</span><span class=\"token variable\">${GRAFANA_USER_PASSWORD}</span>@<span class=\"token variable\">${GRAFANA_HOST_URL}</span>/api/v1/provisioning/alert-rules <span class=\"token punctuation\">\\</span>\n      <span class=\"token parameter variable\">-H</span> <span class=\"token string\">'content-type: application/json'</span> <span class=\"token parameter variable\">-d</span> @./alert.json\n<span class=\"token comment\"># 생성 결과 : {\"id\":11,\"uid\":\"Qvbocu40z\",\"orgID\":1,\"folderUID\":\"7KVKla2Ef\", ...}</span>\n\n<span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">ALERT_RULE_UID</span><span class=\"token operator\">=</span>생성 결과의 uid 값\n\n<span class=\"token comment\"># 조회</span>\n<span class=\"token function\">curl</span> http://<span class=\"token variable\">${GRAFANA_USER_NAME}</span><span class=\"token builtin class-name\">:</span><span class=\"token variable\">${GRAFANA_USER_PASSWORD}</span>@<span class=\"token variable\">${GRAFANA_HOST_URL}</span>/api/v1/provisioning/alert-rules/<span class=\"token variable\">${ALERT_RULE_UID}</span>\n\n<span class=\"token comment\"># 수정</span>\n<span class=\"token function\">curl</span> <span class=\"token parameter variable\">-X</span> PUT http://<span class=\"token variable\">${GRAFANA_USER_NAME}</span><span class=\"token builtin class-name\">:</span><span class=\"token variable\">${GRAFANA_USER_PASSWORD}</span>@<span class=\"token variable\">${GRAFANA_HOST_URL}</span>/api/v1/provisioning/alert-rules/<span class=\"token variable\">${ALERT_RULE_UID}</span> <span class=\"token punctuation\">\\</span>\n      <span class=\"token parameter variable\">-H</span> <span class=\"token string\">'content-type: application/json'</span> <span class=\"token parameter variable\">-d</span> @./alert_mod.json\n\n<span class=\"token comment\"># 삭제</span>\n<span class=\"token function\">curl</span> <span class=\"token parameter variable\">-X</span> DELETE http://<span class=\"token variable\">${GRAFANA_USER_NAME}</span><span class=\"token builtin class-name\">:</span><span class=\"token variable\">${GRAFANA_USER_PASSWORD}</span>@<span class=\"token variable\">${GRAFANA_HOST_URL}</span>/api/v1/provisioning/alert-rules/<span class=\"token variable\">${ALERT_RULE_UID}</span></code></pre></div>\n<ul>\n<li>주요 항목 표현식</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">* node cpu : 100 - (max by(instance) (irate(node_cpu_seconds_total{mode=\"idle\"}[5m])) * 100) \n* node memory : max by(instance) (instance:node_memory_utilisation:ratio{job=\"node-exporter\"}) * 100\n* node disk : max by(instance) ((node_filesystem_size_bytes{job=\"node-exporter\"} - node_filesystem_avail_bytes{job=\"node-exporter\"}) / node_filesystem_size_bytes{job=\"node-exporter\"} * 100)\n* container cpu : 100 * max(rate(container_cpu_usage_seconds_total[5m]) / on (container, pod) kube_pod_container_resource_limits{resource=\"cpu\"}) by (container)\n* container memory : max by (container) (container_memory_working_set_bytes / on (container, pod) kube_pod_container_resource_limits{resource=\"memory\"}) * 100</code></pre></div>\n<h1>참고</h1>\n<hr>\n<ul>\n<li><a href=\"https://api.slack.com/messaging/webhooks\">https://api.slack.com/messaging/webhooks</a></li>\n<li><a href=\"https://github.com/grafana/grafana/blob/main/pkg/services/ngalert/notifier/channels/default_template.go\">https://github.com/grafana/grafana/blob/main/pkg/services/ngalert/notifier/channels/default_template.go</a></li>\n<li><a href=\"https://grafana.com/docs/grafana/latest/alerting/contact-points/message-templating/example-template/\">https://grafana.com/docs/grafana/latest/alerting/contact-points/message-templating/example-template/</a></li>\n<li><a href=\"https://grafana.com/docs/grafana/latest/developers/http_api/curl-examples/\">https://grafana.com/docs/grafana/latest/developers/http_api/curl-examples/</a></li>\n<li><a href=\"https://grafana.com/docs/grafana/latest/developers/http_api/alerting_provisioning/\">https://grafana.com/docs/grafana/latest/developers/http_api/alerting_provisioning/</a></li>\n</ul>","fields":{"slug":"/sw_development/devops/aws-eks-monitoring-grafana/"},"frontmatter":{"title":"AWS. EKS 그라파나 알람 설정하기","searchTexts":["AWS EKS Grafana Alerting Rules Slack","EKS 그라파나 알람 설정 슬랙 전송","EKS kube-prometheus-stack 설치","Grafana Alert Rules"],"category":"sw development","subCategory":"devops","tags":["AWS","Kubernetes","K8S","AWS","EKS","Monitoring","Grafana"],"created":"Oct 10, 2022","updated":"Dec 12, 2022"},"tableOfContents":"<ul>\n<li>\n<p><a href=\"#%EC%A4%80%EB%B9%84%ED%95%98%EA%B8%B0\">준비하기</a></p>\n</li>\n<li>\n<p><a href=\"#%EC%8A%AC%EB%9E%99-%EC%95%8C%EB%A6%BC-%EB%A9%94%EC%84%B8%EC%A7%80-%EC%83%98%ED%94%8C-%ED%99%94%EB%A9%B4\">슬랙 알림 메세지 샘플 화면</a></p>\n</li>\n<li>\n<p><a href=\"#%EC%8A%AC%EB%9E%99-%EC%95%8C%EB%9E%8C-%EC%A0%84%EC%86%A1-%EC%84%A4%EC%A0%95\">슬랙 알람 전송 설정</a></p>\n<ul>\n<li><a href=\"#%EC%8A%AC%EB%9E%99-%EB%A9%94%EC%84%B8%EC%A7%80-%ED%8F%AC%EB%A7%B7-%EC%84%A4%EC%A0%95\">슬랙 메세지 포맷 설정</a></li>\n<li><a href=\"#%EC%8A%AC%EB%9E%99-%EC%97%B0%EB%8F%99-%EC%84%A4%EC%A0%95\">슬랙 연동 설정</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%EA%B7%B8%EB%9D%BC%ED%8C%8C%EB%82%98-%EC%95%8C%EB%9E%8C-%EA%B7%9C%EC%B9%99-%EC%B6%94%EA%B0%80\">그라파나 알람 규칙 추가</a></p>\n<ul>\n<li><a href=\"#%ED%99%98%EA%B2%BD%EB%B3%80%EC%88%98-%EC%84%A4%EC%A0%95\">환경변수 설정</a></li>\n<li><a href=\"#%ED%8F%B4%EB%8D%94-%EC%83%9D%EC%84%B1\">폴더 생성</a></li>\n<li><a href=\"#%EC%95%8C%EB%9E%8C-%EA%B7%9C%EC%B9%99\">알람 규칙</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%EC%B0%B8%EA%B3%A0\">참고</a></p>\n</li>\n</ul>"}},"pageContext":{"slug":"/sw_development/devops/aws-eks-monitoring-grafana/","prev":{"fields":{"slug":"/sw_development/etc/google-domain-redirect-config/"},"frontmatter":{"title":"도메인 주소 변경하고 새주소로 리다이렉션하기","tags":["domain"],"category":"sw development","subCategory":"etc"}},"next":{"fields":{"slug":"/sw_development/devops/aws-eks-monitoring-kube-prometheus-stack/"},"frontmatter":{"title":"AWS. EKS 프로메테우스 그라파나 모니터링 구축하기","tags":["AWS","Kubernetes","K8S","AWS","EKS","Monitoring","Prometheus","Grafana"],"category":"sw development","subCategory":"devops"}}}},
    "staticQueryHashes": ["2152785458","3427181268"]}