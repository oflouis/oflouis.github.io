{"componentChunkName":"component---src-templates-post-template-js","path":"/sw_development/devops/aws-eks-application-logging-02/","result":{"data":{"site":{"siteMetadata":{"title":"Louis","author":"Louis"}},"markdownRemark":{"id":"bee9fd08-2a70-5752-9fdc-3456dfa2de9f","excerpt":"AWS EKS의 애플리케이션 로그를 AWS OpenSearch로 수집하고 관리하기 위한 내용을 정리한다. 로그 전송은 Fluent Bit을 사용했다. 내용은 간단하지만 한 개의 포스팅에 포함하려니 내용이 길어지고 가독성을 해쳐서 몇 개의 파트로 나눴다. 본 포스팅은 K8S의 로그 수집 권한 및 인가 설정을 다룬다.","html":"<p>AWS EKS의 애플리케이션 로그를 AWS OpenSearch로 수집하고 관리하기 위한 내용을 정리한다. 로그 전송은 Fluent Bit을 사용했다.</p>\n<p>내용은 간단하지만 한 개의 포스팅에 포함하려니 내용이 길어지고 가독성을 해쳐서 몇 개의 파트로 나눴다.</p>\n<p>본 포스팅은 K8S의 로그 수집 권한 및 인가 설정을 다룬다.</p>\n<!-- more -->\n<h1>파트 목차</h1>\n<hr>\n<ul>\n<li><a href=\"https://oflouis.dev/sw_development/devops/aws-eks-application-logging-01/\">로그 수집 구성 개요</a></li>\n<li><strong>AWS IRSA, K8S RBAC 설정 : 현재 포스트</strong></li>\n<li><a href=\"https://oflouis.dev/sw_development/devops/aws-eks-application-logging-03/\">DaemonSet 설정</a></li>\n<li><a href=\"https://oflouis.dev/sw_development/devops/aws-eks-application-logging-04/\">로그 로테이트 설정</a></li>\n<li><a href=\"https://oflouis.dev/sw_development/devops/aws-eks-application-logging-05/\">로그 멀티라인 파싱 설정</a></li>\n</ul>\n<h1>AWS IRSA (IAM Role for Service Accounts) &#x26; RBAC 설정</h1>\n<hr>\n<p>Fluent Bit DaemonSet이 파드의 로그에 접근할 수 있도록 RBAC 방식의 인가 설정을 한다.</p>\n<h2>IAM Identity Provider 생성</h2>\n<ul>\n<li>EKS의 OIDC identity provider 생성</li>\n<li><strong>콘솔 메뉴 : IAM > Access Management > Identity Providers > Add Provider</strong>\n<ul>\n<li>Provider Type : OpenID Connect</li>\n<li>Provider URL : EKS 클러스터 Overview 에서 확인\n<ul>\n<li>콘솔 메뉴 : EKS > Clusters > 클러스터 선택 > Overview > OpenID Connect provider URL</li>\n<li>예 : <a href=\"https://oidc.eks.ap-southeast-1.amazonaws.com/id/EXAMPLED539D4633E53DE1B71EXAMPLE\">https://oidc.eks.ap-southeast-1.amazonaws.com/id/EXAMPLED539D4633E53DE1B71EXAMPLE</a></li>\n</ul>\n</li>\n<li>Audience : sts.amazonaws.com</li>\n</ul>\n</li>\n</ul>\n<h2>IAM Policy 생성</h2>\n<ul>\n<li><strong>콘솔 메뉴 : IAM > Access Management > Policies > Create policy</strong></li>\n<li>JSON Editor로 내용을 작성\n<ul>\n<li>${OPENSEARCH_ARN} : 생성한 OpenSearch의 ARN 정보로 교체\n<ul>\n<li>예: arn:aws:es:ap-southeast-1:111122223333:domain/logging-test</li>\n</ul>\n</li>\n</ul>\n<div class=\"gatsby-code-title gatsby-code-title-custom\">policy-json</div>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"Version\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"2012-10-17\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"Statement\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token punctuation\">{</span>\n            <span class=\"token property\">\"Action\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n                <span class=\"token string\">\"es:ESHttp*\"</span>\n            <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n<span class=\"gatsby-highlight-code-line\">            <span class=\"token property\">\"Resource\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"${OPENSEARCH_ARN}\"</span><span class=\"token punctuation\">,</span></span>            <span class=\"token property\">\"Effect\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Allow\"</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n</li>\n</ul>\n<h2>IAM Role 생성</h2>\n<ul>\n<li><strong>콘솔 메뉴 : IAM > Access Management > Roles > Create role</strong></li>\n<li>AWS Service : EC2</li>\n<li>Permissions : 위에 생성한 IAM Policy를 선택</li>\n<li>Trust Relationship 내용 작성\n<ul>\n<li>${IDENTITY_PROVIDER_ARN} : 위에서 생성한 EKS OIDC Provider ARN 값을 사용\n<ul>\n<li>예 : arn:aws:iam::111122223333:oidc-provider/oidc.eks.region-code.amazonaws.com/id/EXAMPLED539D4633E53DE1B71EXAMPLE</li>\n</ul>\n</li>\n<li>${IDENTITY_PROVIDER} : 위에서 생성한 EKS OIDC Provider 값을 사용\n<ul>\n<li>예 : oidc.eks.region-code.amazonaws.com/id/EXAMPLED539D4633E53DE1B71EXAMPLE</li>\n</ul>\n</li>\n<li>${SERVICE_ACCOUNT_NAME} : 생성할 Service Account 정보를 기입\n<ul>\n<li>예 : system:serviceaccount:logging:fluent-bit</li>\n</ul>\n</li>\n</ul>\n<div class=\"gatsby-code-title gatsby-code-title-custom\">trust-relationship</div>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"Version\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"2012-10-17\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"Statement\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token punctuation\">{</span>\n            <span class=\"token property\">\"Effect\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Allow\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token property\">\"Principal\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n<span class=\"gatsby-highlight-code-line\">                <span class=\"token property\">\"Federated\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"${IDENTITY_PROVIDER_ARN}\"</span></span>            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n            <span class=\"token property\">\"Action\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"sts:AssumeRoleWithWebIdentity\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token property\">\"Condition\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token property\">\"StringEquals\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n<span class=\"gatsby-highlight-code-line\">                    <span class=\"token property\">\"${IDENTITY_PROVIDER}:aud\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"sts.amazonaws.com\"</span><span class=\"token punctuation\">,</span></span><span class=\"gatsby-highlight-code-line\">                    <span class=\"token property\">\"${IDENTITY_PROVIDER}:sub\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"${SERVICE_ACCOUNT_NAME}\"</span><span class=\"token punctuation\">,</span></span>                <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n</li>\n</ul>\n<h2>Service Account 생성</h2>\n<ul>\n<li>${IAM_ROLE_ARN} : 위에서 생성한 Role ARN (예 : arn:aws:iam::111122223333:role/logging-role)</li>\n<li>Service Account 이름은 데몬셋 파드에서 이를 할당할 때 사용한다.</li>\n</ul>\n<div class=\"gatsby-code-title gatsby-code-title-custom\">service-account.yaml</div>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> ServiceAccount\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n<span class=\"gatsby-highlight-code-line\">  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> fluent<span class=\"token punctuation\">-</span>bit</span>  <span class=\"token key atrule\">annotations</span><span class=\"token punctuation\">:</span>\n<span class=\"gatsby-highlight-code-line\">    <span class=\"token key atrule\">eks.amazonaws.com/role-arn</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span>IAM_ROLE_ARN<span class=\"token punctuation\">}</span></span>  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> logging</code></pre></div>\n<h2>Cluster Role 생성</h2>\n<div class=\"gatsby-code-title gatsby-code-title-custom\">cluster-role.yaml</div>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> rbac.authorization.k8s.io/v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> ClusterRole\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> fluent<span class=\"token punctuation\">-</span>bit<span class=\"token punctuation\">-</span>read\n<span class=\"token key atrule\">rules</span><span class=\"token punctuation\">:</span>\n<span class=\"token punctuation\">-</span> <span class=\"token key atrule\">apiGroups</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token string\">\"\"</span>\n  <span class=\"token key atrule\">resources</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> namespaces\n  <span class=\"token punctuation\">-</span> pods\n  <span class=\"token key atrule\">verbs</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> get\n  <span class=\"token punctuation\">-</span> list\n  <span class=\"token punctuation\">-</span> watch</code></pre></div>\n<h2>Cluster Role Binding 생성</h2>\n<div class=\"gatsby-code-title gatsby-code-title-custom\">cluster-role-binding.yaml</div>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> rbac.authorization.k8s.io/v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> ClusterRoleBinding\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> fluent<span class=\"token punctuation\">-</span>bit<span class=\"token punctuation\">-</span>read\n<span class=\"token key atrule\">roleRef</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">apiGroup</span><span class=\"token punctuation\">:</span> rbac.authorization.k8s.io\n  <span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> ClusterRole\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> fluent<span class=\"token punctuation\">-</span>bit<span class=\"token punctuation\">-</span>read\n<span class=\"token key atrule\">subjects</span><span class=\"token punctuation\">:</span>\n<span class=\"token punctuation\">-</span> <span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> ServiceAccount\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> fluent<span class=\"token punctuation\">-</span>bit\n  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> logging</code></pre></div>\n<h1>참고</h1>\n<hr>\n<ul>\n<li><a href=\"https://docs.aws.amazon.com/eks/latest/userguide/iam-roles-for-service-accounts.html\">https://docs.aws.amazon.com/eks/latest/userguide/iam-roles-for-service-accounts.html</a></li>\n</ul>","fields":{"slug":"/sw_development/devops/aws-eks-application-logging-02/"},"frontmatter":{"title":"AWS. EKS 애플리케이션 로그 수집하기 (2)","searchTexts":["AWS EKS 로그 수집","AWS OpenSearch에 Kubernetes 로그 수집","EKS와 Fluent Bit, OpenSearch 로그 수집"],"category":"sw development","subCategory":"devops","tags":["AWS","Kubernetes","K8S","OpenSearch","Logging","EKS","EFK"],"created":"Sep 11, 2022","updated":"Oct 15, 2022"},"tableOfContents":"<ul>\n<li>\n<p><a href=\"#%ED%8C%8C%ED%8A%B8-%EB%AA%A9%EC%B0%A8\">파트 목차</a></p>\n</li>\n<li>\n<p><a href=\"#aws-irsa-iam-role-for-service-accounts--rbac-%EC%84%A4%EC%A0%95\">AWS IRSA (IAM Role for Service Accounts) &#x26; RBAC 설정</a></p>\n<ul>\n<li><a href=\"#iam-identity-provider-%EC%83%9D%EC%84%B1\">IAM Identity Provider 생성</a></li>\n<li><a href=\"#iam-policy-%EC%83%9D%EC%84%B1\">IAM Policy 생성</a></li>\n<li><a href=\"#iam-role-%EC%83%9D%EC%84%B1\">IAM Role 생성</a></li>\n<li><a href=\"#service-account-%EC%83%9D%EC%84%B1\">Service Account 생성</a></li>\n<li><a href=\"#cluster-role-%EC%83%9D%EC%84%B1\">Cluster Role 생성</a></li>\n<li><a href=\"#cluster-role-binding-%EC%83%9D%EC%84%B1\">Cluster Role Binding 생성</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%EC%B0%B8%EA%B3%A0\">참고</a></p>\n</li>\n</ul>"}},"pageContext":{"slug":"/sw_development/devops/aws-eks-application-logging-02/","prev":{"fields":{"slug":"/sw_development/devops/aws-eks-application-logging-03/"},"frontmatter":{"title":"AWS. EKS 애플리케이션 로그 수집하기 (3)","tags":["AWS","Kubernetes","K8S","OpenSearch","Logging","EKS","EFK"],"category":"sw development","subCategory":"devops"}},"next":{"fields":{"slug":"/sw_development/devops/aws-eks-application-logging-05/"},"frontmatter":{"title":"AWS. EKS 애플리케이션 로그 수집하기 (5)","tags":["AWS","Kubernetes","K8S","OpenSearch","Logging","EKS","EFK"],"category":"sw development","subCategory":"devops"}}}},"staticQueryHashes":["2152785458","3427181268"]}